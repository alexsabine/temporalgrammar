<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRR: Room to Planck Scale</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #e0e0e0; font-family: 'Courier New', monospace; overflow: hidden; height: 100vh; }
        #mainCanvas { display: block; cursor: crosshair; }
        
        .overlay { position: fixed; pointer-events: none; z-index: 100; }
        .top-left { top: 20px; left: 20px; }
        .top-right { top: 20px; right: 20px; text-align: right; }
        .bottom-left { bottom: 20px; left: 20px; }
        .bottom-right { bottom: 20px; right: 20px; text-align: right; }
        .bottom-center { bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; }
        
        .panel {
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(202, 168, 126, 0.3);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }
        
        .title { color: #caa87e; font-size: 1.4em; letter-spacing: 3px; margin-bottom: 5px; }
        .subtitle { color: #6a7a8a; font-size: 0.7em; letter-spacing: 2px; }
        .scale-display { font-size: 2em; color: #fff; margin: 10px 0; }
        .scale-name { color: #caa87e; font-size: 1.1em; margin-bottom: 5px; }
        .scale-description { color: #8a9aaa; font-size: 0.75em; max-width: 250px; }
        
        .crr-panel { min-width: 220px; }
        .crr-header { color: #8a9aba; font-size: 0.65em; letter-spacing: 2px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(202, 168, 126, 0.2); }
        .crr-equation { background: rgba(202, 168, 126, 0.1); padding: 8px 12px; border-radius: 4px; margin-bottom: 10px; font-family: 'Times New Roman', serif; font-size: 0.95em; text-align: center; color: #caa87e; }
        .crr-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.75em; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .crr-label { color: #6a7a8a; }
        .crr-value { color: #a0b0c0; }
        
        .symmetry-z2 { color: #ff9a7a; }
        .symmetry-so2 { color: #7affda; }
        .symmetry-planck { color: #ff7aff; }
        
        .depth-indicator { width: 300px; margin-top: 15px; }
        .depth-track { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; position: relative; overflow: hidden; }
        .depth-fill { height: 100%; background: linear-gradient(90deg, #caa87e, #7affda, #ff7aff); border-radius: 4px; transition: width 0.1s; }
        .depth-markers { display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.5em; color: #5a6a7a; }
        
        .metric-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 0.7em; }
        .metric-value { color: #7affaa; }
        .instructions { color: #5a6a7a; font-size: 0.65em; margin-top: 10px; }
        
        .chain { display: flex; gap: 3px; align-items: center; flex-wrap: wrap; max-width: 500px; justify-content: center; }
        .chain-node { padding: 3px 6px; background: rgba(255,255,255,0.05); border-radius: 3px; font-size: 0.55em; color: #4a5a6a; transition: all 0.3s; }
        .chain-node.active { background: rgba(202, 168, 126, 0.3); color: #caa87e; }
        .chain-node.current { background: rgba(202, 168, 126, 0.6); color: #fff; box-shadow: 0 0 10px rgba(202, 168, 126, 0.5); }
        .chain-arrow { color: #2a3a4a; font-size: 0.5em; }
    </style>
</head>
<body>
    <canvas id="mainCanvas"></canvas>
    
    <div class="overlay top-left">
        <div class="panel">
            <div class="title">☀ CRR DEEP ZOOM</div>
            <div class="subtitle">ROOM → PLANCK SCALE</div>
            <div class="instructions">Scroll to zoom · R to reset · P for Planck</div>
        </div>
    </div>
    
    <div class="overlay top-right">
        <div class="panel">
            <div class="scale-name" id="scaleName">Room View</div>
            <div class="scale-display" id="scaleDisplay">2 m</div>
            <div class="scale-description" id="scaleDesc">You at your desk, viewing the screen</div>
        </div>
    </div>
    
    <div class="overlay bottom-left">
        <div class="panel crr-panel">
            <div class="crr-header">ACTIVE CRR LAYER</div>
            <div class="crr-equation">R = ∫φ exp(C/Ω) dτ</div>
            <div class="crr-row"><span class="crr-label">Symmetry</span><span class="crr-value" id="symmetryDisplay">Z₂</span></div>
            <div class="crr-row"><span class="crr-label">Ω</span><span class="crr-value" id="omegaDisplay">1/π</span></div>
            <div class="crr-row"><span class="crr-label">τ (period)</span><span class="crr-value" id="tauDisplay">100 ms</span></div>
            <div class="crr-row"><span class="crr-label">Frequency</span><span class="crr-value" id="freqDisplay">10 Hz</span></div>
            <div class="depth-indicator">
                <div class="depth-track"><div class="depth-fill" id="depthFill" style="width: 0%"></div></div>
                <div class="depth-markers"><span>Room</span><span>Atom</span><span>Nucleus</span><span>Planck</span></div>
            </div>
        </div>
    </div>
    
    <div class="overlay bottom-right">
        <div class="panel">
            <div class="crr-header">LIVE METRICS</div>
            <div class="metric-row"><span>Coherence C</span><span class="metric-value" id="coherenceC">0.0000</span></div>
            <div class="metric-row"><span>Zoom depth</span><span class="metric-value" id="zoomDepth">10⁰</span></div>
            <div class="metric-row"><span>Ruptures/sec</span><span class="metric-value" id="rupturesPerSec">10</span></div>
        </div>
    </div>
    
    <div class="overlay bottom-center">
        <div class="panel" style="padding: 10px 20px;">
            <div class="chain" id="perceptionChain"></div>
        </div>
    </div>

    <script>
        // CRR Constants
        const OMEGA_Z2 = 1 / Math.PI;
        const OMEGA_SO2 = 1 / (2 * Math.PI);
        const L_PLANCK = 1.616255e-35;
        const T_PLANCK = 5.391247e-44;
        const C_LIGHT = 299792458;
        
        // Scale definitions covering 35 orders of magnitude
        const SCALES = [
            { scale: 2, name: "Room View", desc: "You at your desk, coffee in hand", symmetry: "Z₂", omega: OMEGA_Z2, tau: 0.1, freq: 10 },
            { scale: 0.4, name: "Screen", desc: "☀ Coffee and Claude time?", symmetry: "Z₂", omega: OMEGA_Z2, tau: 1/60, freq: 60 },
            { scale: 0.1, name: "Text", desc: "Individual glyphs rendered", symmetry: "Z₂", omega: OMEGA_Z2, tau: 1/60, freq: 60 },
            { scale: 0.01, name: "Letter", desc: "Single character 'C'", symmetry: "Z₂", omega: OMEGA_Z2, tau: 1/60, freq: 60 },
            { scale: 0.001, name: "Pixel Grid", desc: "LCD pixels, 60Hz refresh", symmetry: "Z₂", omega: OMEGA_Z2, tau: 1/60, freq: 60 },
            { scale: 3e-4, name: "Single Pixel", desc: "RGB subpixel triad", symmetry: "Z₂", omega: OMEGA_Z2, tau: 1/240, freq: 240 },
            { scale: 1e-4, name: "Subpixel", desc: "Liquid crystal element", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-3, freq: 1e3 },
            { scale: 1e-5, name: "LC Molecules", desc: "Molecular rotation in E-field", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-6, freq: 1e6 },
            { scale: 5e-7, name: "Wavelength", desc: "~500nm visible light", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1.7e-15, freq: 6e14 },
            { scale: 1e-8, name: "Molecule", desc: "Protein-scale structures", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-12, freq: 1e12 },
            { scale: 1e-9, name: "Nanometer", desc: "DNA helix width", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-13, freq: 1e13 },
            { scale: 1e-10, name: "Ångström", desc: "Atomic bond lengths", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-15, freq: 1e15 },
            { scale: 1e-11, name: "Atomic Shell", desc: "Electron probability clouds", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-16, freq: 1e16 },
            { scale: 1e-13, name: "Electron", desc: "Classical electron radius", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-20, freq: 1e20 },
            { scale: 1e-15, name: "Nucleus", desc: "Protons and neutrons", symmetry: "Z₂", omega: OMEGA_Z2, tau: 1e-23, freq: 1e23 },
            { scale: 1e-16, name: "Nucleon", desc: "Single proton structure", symmetry: "Z₂", omega: OMEGA_Z2, tau: 1e-24, freq: 1e24 },
            { scale: 1e-18, name: "Quark", desc: "Quark confinement, QCD", symmetry: "Z₂", omega: OMEGA_Z2, tau: 1e-26, freq: 1e26 },
            { scale: 1e-20, name: "Electroweak", desc: "W/Z boson scale", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-28, freq: 1e28 },
            { scale: 1e-25, name: "GUT Scale", desc: "Forces unify", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-35, freq: 1e35 },
            { scale: 1e-30, name: "String", desc: "Theoretical string length", symmetry: "SO(2)", omega: OMEGA_SO2, tau: 1e-40, freq: 1e40 },
            { scale: 1e-34, name: "Near Planck", desc: "Quantum gravity regime", symmetry: "?", omega: OMEGA_Z2, tau: 1e-43, freq: 1e43 },
            { scale: L_PLANCK, name: "PLANCK", desc: "ℓₚ = 1.616×10⁻³⁵m — End of space", symmetry: "?", omega: OMEGA_Z2, tau: T_PLANCK, freq: 1/T_PLANCK }
        ];
        
        const CHAIN = ["You","Eye","Retina","V1","Screen","Pixel","Photon","Molecule","Atom","Nucleus","Quark","String","Planck"];
        
        let canvas, ctx, width, height;
        let currentScale = 2, targetScale = 2;
        let startTime = Date.now();
        let sessionCoherence = 0;
        
        function init() {
            canvas = document.getElementById('mainCanvas');
            ctx = canvas.getContext('2d');
            resize();
            window.addEventListener('resize', resize);
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                targetScale *= e.deltaY > 0 ? 1.15 : 0.87;
                targetScale = Math.max(L_PLANCK, Math.min(2, targetScale));
            }, { passive: false });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'r' || e.key === 'R') targetScale = 2;
                if (e.key === 'p' || e.key === 'P') targetScale = L_PLANCK;
            });
            
            // Build chain
            document.getElementById('perceptionChain').innerHTML = CHAIN.map((n,i) => 
                `<span class="chain-node" id="chain-${i}">${n}</span>${i<CHAIN.length-1?'<span class="chain-arrow">→</span>':''}`
            ).join('');
            
            requestAnimationFrame(animate);
        }
        
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        
        function getScaleInfo(scale) {
            for (let i = 0; i < SCALES.length; i++) {
                if (scale >= SCALES[i].scale) return SCALES[Math.max(0, i)];
            }
            return SCALES[SCALES.length - 1];
        }
        
        function formatScale(s) {
            if (s >= 1) return s.toFixed(1) + ' m';
            if (s >= 0.01) return (s * 100).toFixed(1) + ' cm';
            if (s >= 1e-3) return (s * 1000).toFixed(1) + ' mm';
            if (s >= 1e-6) return (s * 1e6).toFixed(1) + ' μm';
            if (s >= 1e-9) return (s * 1e9).toFixed(1) + ' nm';
            if (s >= 1e-12) return (s * 1e12).toFixed(1) + ' pm';
            if (s >= 1e-15) return (s * 1e15).toFixed(1) + ' fm';
            return s.toExponential(2) + ' m';
        }
        
        function formatTime(t) {
            if (t >= 1) return t.toFixed(2) + ' s';
            if (t >= 1e-3) return (t * 1e3).toFixed(2) + ' ms';
            if (t >= 1e-6) return (t * 1e6).toFixed(2) + ' μs';
            if (t >= 1e-9) return (t * 1e9).toFixed(2) + ' ns';
            if (t >= 1e-12) return (t * 1e12).toFixed(2) + ' ps';
            if (t >= 1e-15) return (t * 1e15).toFixed(2) + ' fs';
            return t.toExponential(1) + ' s';
        }
        
        function formatFreq(f) {
            if (f < 1e3) return f.toFixed(0) + ' Hz';
            if (f < 1e6) return (f/1e3).toFixed(1) + ' kHz';
            if (f < 1e9) return (f/1e6).toFixed(1) + ' MHz';
            if (f < 1e12) return (f/1e9).toFixed(1) + ' GHz';
            if (f < 1e15) return (f/1e12).toFixed(1) + ' THz';
            return f.toExponential(1) + ' Hz';
        }
        
        // Rendering functions for each domain
        function render(t) {
            const info = getScaleInfo(currentScale);
            const logScale = Math.log10(currentScale);
            
            // Background color transition
            const hue = 220 + (Math.log10(2) - logScale) * 2;
            const lightness = Math.max(5, 15 - (Math.log10(2) - logScale) * 0.3);
            ctx.fillStyle = `hsl(${hue}, 30%, ${lightness}%)`;
            ctx.fillRect(0, 0, width, height);
            
            const cx = width / 2, cy = height / 2;
            
            // Domain-specific rendering based on scale
            if (currentScale > 0.5) renderRoom(t, cx, cy);
            else if (currentScale > 0.05) renderScreen(t, cx, cy);
            else if (currentScale > 0.005) renderText(t, cx, cy);
            else if (currentScale > 5e-4) renderPixels(t, cx, cy);
            else if (currentScale > 5e-5) renderSubpixel(t, cx, cy);
            else if (currentScale > 1e-7) renderWavelength(t, cx, cy);
            else if (currentScale > 1e-9) renderMolecule(t, cx, cy);
            else if (currentScale > 1e-11) renderAtom(t, cx, cy);
            else if (currentScale > 1e-14) renderElectron(t, cx, cy);
            else if (currentScale > 1e-17) renderNucleus(t, cx, cy);
            else if (currentScale > 1e-20) renderQuark(t, cx, cy);
            else if (currentScale > 1e-28) renderElectroweak(t, cx, cy);
            else if (currentScale > 1e-33) renderString(t, cx, cy);
            else renderPlanck(t, cx, cy);
        }
        
        function renderRoom(t, cx, cy) {
            // Desk
            ctx.fillStyle = '#2a2520';
            ctx.fillRect(width*0.1, height*0.65, width*0.8, height*0.35);
            
            // Screen
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(width*0.28, height*0.13, width*0.44, height*0.42);
            ctx.fillStyle = '#f5f0e6';
            ctx.fillRect(width*0.3, height*0.15, width*0.4, height*0.38);
            
            ctx.fillStyle = '#4a4a4a';
            ctx.font = `${width*0.025}px Georgia`;
            ctx.textAlign = 'center';
            ctx.fillText('☀ Coffee and Claude time?', cx, height*0.35);
            
            // Coffee
            ctx.fillStyle = '#6b4423';
            ctx.beginPath();
            ctx.ellipse(width*0.75, height*0.7, 25, 8, 0, 0, Math.PI*2);
            ctx.fill();
            ctx.fillRect(width*0.75-25, height*0.7, 50, 40);
            
            // Steam
            ctx.strokeStyle = `rgba(200,200,200,${0.3+0.2*Math.sin(t*2)})`;
            ctx.lineWidth = 2;
            for(let i=0;i<3;i++){
                ctx.beginPath();
                ctx.moveTo(width*0.75-10+i*10, height*0.68);
                ctx.bezierCurveTo(width*0.75-15+i*10,height*0.6+Math.sin(t*3+i)*5, width*0.75-5+i*10,height*0.55, width*0.75-10+i*10,height*0.5);
                ctx.stroke();
            }
        }
        
        function renderScreen(t, cx, cy) {
            ctx.fillStyle = '#f5f0e6';
            ctx.fillRect(0, 0, width, height);
            
            // Scan line
            ctx.fillStyle = 'rgba(202,168,126,0.1)';
            ctx.fillRect(0, (t*100)%height, width, 3);
            
            ctx.fillStyle = '#caa87e';
            ctx.font = `${height*0.08}px Georgia`;
            ctx.textAlign = 'center';
            ctx.fillText('☀', width*0.18, cy);
            
            ctx.fillStyle = '#4a4a4a';
            ctx.font = `${height*0.12}px Georgia`;
            ctx.fillText('Coffee and Claude time?', cx+width*0.05, cy+10);
        }
        
        function renderText(t, cx, cy) {
            ctx.fillStyle = '#f5f0e6';
            ctx.fillRect(0, 0, width, height);
            
            ctx.fillStyle = '#4a4a4a';
            ctx.font = `bold ${Math.min(width,height)*0.8}px Georgia`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('C', cx, cy);
            
            // Pixel grid hint
            ctx.strokeStyle = 'rgba(202,168,126,0.15)';
            const gs = 40;
            for(let x=0;x<width;x+=gs){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,height); ctx.stroke(); }
            for(let y=0;y<height;y+=gs){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(width,y); ctx.stroke(); }
        }
        
        function renderPixels(t, cx, cy) {
            const ps = Math.max(20, Math.min(80, height/8));
            const cols = Math.ceil(width/ps)+1, rows = Math.ceil(height/ps)+1;
            
            for(let r=0;r<rows;r++){
                for(let c=0;c<cols;c++){
                    const px=(c-cols/2)/cols, py=(r-rows/2)/rows;
                    const d=Math.sqrt(px*px+py*py);
                    const inC = d>0.15 && d<0.4 && (px<0.1||Math.abs(py)>0.2);
                    
                    ctx.fillStyle = inC ? '#4a4a4a' : '#f5f0e6';
                    ctx.fillRect(c*ps+1, r*ps+1, ps-2, ps-2);
                }
            }
            
            // Refresh highlight
            ctx.strokeStyle = `rgba(202,168,126,${0.5+0.5*Math.sin(t*60*Math.PI*2)})`;
            ctx.lineWidth = 3;
            ctx.strokeRect(Math.floor(cols/2)*ps, Math.floor(rows/2)*ps, ps-2, ps-2);
        }
        
        function renderSubpixel(t, cx, cy) {
            ctx.fillStyle = '#0a0808';
            ctx.fillRect(0, 0, width, height);
            
            const sw = (width-60)/3;
            [[255,0,0,'625nm'],[0,255,0,'530nm'],[0,0,255,'470nm']].forEach((c,i)=>{
                const intensity = 0.4+0.1*Math.sin(t*10+i);
                ctx.fillStyle = `rgb(${Math.floor(c[0]*intensity)},${Math.floor(c[1]*intensity)},${Math.floor(c[2]*intensity)})`;
                ctx.fillRect(20+i*(sw+10), 30, sw, height-60);
                
                ctx.fillStyle = '#888';
                ctx.font = '14px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(c[3], 20+i*(sw+10)+sw/2, height-10);
            });
        }
        
        function renderWavelength(t, cx, cy) {
            const amp = height*0.15, wl = width/4, speed = 200;
            
            // E-field
            ctx.strokeStyle = '#ff4444';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for(let x=0;x<width;x+=2){
                const y = cy + amp*Math.sin((x-t*speed)*2*Math.PI/wl);
                x===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
            }
            ctx.stroke();
            
            // B-field circles
            ctx.strokeStyle = '#4444ff';
            ctx.lineWidth = 2;
            for(let x=wl/4;x<width;x+=wl/2){
                const bf = Math.cos((x-t*speed)*2*Math.PI/wl);
                ctx.beginPath();
                ctx.arc(x, cy, Math.abs(bf)*20, 0, Math.PI*2);
                ctx.stroke();
            }
            
            ctx.fillStyle = '#ffaa00';
            ctx.font = '14px Courier New';
            ctx.fillText('λ ≈ 500nm — SO(2) symmetry', 20, 30);
        }
        
        function renderMolecule(t, cx, cy) {
            // DNA-like helix
            ctx.lineWidth = 4;
            for(let y=0;y<height;y+=3){
                const phase = y*0.03+t*2;
                const x1 = cx + Math.sin(phase)*80;
                const x2 = cx + Math.sin(phase+Math.PI)*80;
                
                ctx.fillStyle = `hsl(${200+Math.sin(phase)*30},70%,50%)`;
                ctx.beginPath(); ctx.arc(x1,y,5,0,Math.PI*2); ctx.fill();
                
                ctx.fillStyle = `hsl(${320+Math.sin(phase)*30},70%,50%)`;
                ctx.beginPath(); ctx.arc(x2,y,5,0,Math.PI*2); ctx.fill();
                
                if(y%20<3){
                    ctx.strokeStyle = 'rgba(255,255,200,0.5)';
                    ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
                }
            }
        }
        
        function renderAtom(t, cx, cy) {
            // Electron probability clouds
            for(let r=Math.min(width,height)*0.45;r>10;r-=12){
                const alpha = (1-r/(Math.min(width,height)*0.45))*0.3;
                ctx.strokeStyle = `hsla(${200+r/2},70%,60%,${alpha})`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(cx, cy, r+Math.sin(t*5+r*0.1)*5, 0, Math.PI*2);
                ctx.stroke();
            }
            
            // Nucleus
            const grad = ctx.createRadialGradient(cx,cy,0,cx,cy,20);
            grad.addColorStop(0,'#fff'); grad.addColorStop(0.5,'#ffaa00'); grad.addColorStop(1,'#ff4400');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(cx,cy,15,0,Math.PI*2); ctx.fill();
        }
        
        function renderElectron(t, cx, cy) {
            // Self-energy fluctuations
            const grad = ctx.createRadialGradient(cx,cy,0,cx,cy,150);
            grad.addColorStop(0,'rgba(0,200,255,0.8)');
            grad.addColorStop(0.5,'rgba(0,150,255,0.3)');
            grad.addColorStop(1,'rgba(0,50,255,0)');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(cx,cy,150,0,Math.PI*2); ctx.fill();
            
            // Virtual photons
            for(let i=0;i<20;i++){
                const angle = t*5+i*0.3;
                const r = 30+Math.sin(t*10+i)*25;
                ctx.fillStyle = `rgba(255,255,200,${0.5+0.3*Math.sin(t*15+i)})`;
                ctx.beginPath();
                ctx.arc(cx+Math.cos(angle)*r, cy+Math.sin(angle)*r, 3, 0, Math.PI*2);
                ctx.fill();
            }
        }
        
        function renderNucleus(t, cx, cy) {
            // Packed nucleons
            const nucleonR = 25;
            const nucleons = [];
            for(let i=0;i<12;i++){
                const layer = Math.floor(i/4);
                const angle = (i%4)*Math.PI/2 + layer*0.3 + t*0.5;
                const r = layer*nucleonR*1.5 + nucleonR;
                nucleons.push({
                    x: cx + Math.cos(angle)*r + Math.sin(t*2+i)*5,
                    y: cy + Math.sin(angle)*r + Math.cos(t*2+i)*5,
                    isProton: i<6
                });
            }
            
            nucleons.forEach(n=>{
                const grad = ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,nucleonR);
                grad.addColorStop(0, n.isProton?'#ff8888':'#8888ff');
                grad.addColorStop(1, n.isProton?'#ff4444':'#4444ff');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(n.x,n.y,nucleonR,0,Math.PI*2); ctx.fill();
            });
            
            // Gluon exchange
            ctx.strokeStyle = 'rgba(0,255,0,0.3)';
            ctx.lineWidth = 2;
            nucleons.forEach((n1,i)=>{
                nucleons.slice(i+1).forEach(n2=>{
                    if(Math.hypot(n1.x-n2.x,n1.y-n2.y)<nucleonR*3){
                        ctx.beginPath(); ctx.moveTo(n1.x,n1.y); ctx.lineTo(n2.x,n2.y); ctx.stroke();
                    }
                });
            });
        }
        
        function renderQuark(t, cx, cy) {
            // Color field spirals
            ['#ff0000','#00ff00','#0000ff'].forEach((col,i)=>{
                ctx.strokeStyle = col;
                ctx.globalAlpha = 0.3;
                ctx.lineWidth = 4;
                ctx.beginPath();
                for(let r=20;r<200;r+=5){
                    const a = t*2+i*Math.PI*2/3 + r*0.05;
                    const x = cx + Math.cos(a)*r;
                    const y = cy + Math.sin(a)*r;
                    r===20 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
                }
                ctx.stroke();
            });
            ctx.globalAlpha = 1;
            
            // Central quark
            const grad = ctx.createRadialGradient(cx,cy,0,cx,cy,30);
            grad.addColorStop(0,'#fff'); grad.addColorStop(0.5,'#ff88ff'); grad.addColorStop(1,'#8800ff');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(cx,cy,25,0,Math.PI*2); ctx.fill();
        }
        
        function renderElectroweak(t, cx, cy) {
            // Forces converging
            [['EM','#ffff00',0],['Weak','#00ffff',Math.PI]].forEach(([name,col,phase])=>{
                const x = cx + Math.cos(t+phase)*50;
                const y = cy + Math.sin(t+phase)*50;
                
                ctx.strokeStyle = col;
                ctx.globalAlpha = 0.3;
                for(let r=20;r<150;r+=25){
                    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.stroke();
                }
                ctx.globalAlpha = 1;
                
                ctx.fillStyle = col;
                ctx.beginPath(); ctx.arc(x,y,20,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = '#000';
                ctx.font = '10px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(name,x,y+3);
            });
            
            ctx.fillStyle = `rgba(255,255,255,${0.5+0.3*Math.sin(t*3)})`;
            ctx.beginPath(); ctx.arc(cx,cy,30,0,Math.PI*2); ctx.fill();
        }
        
        function renderString(t, cx, cy) {
            // Vibrating string
            ctx.strokeStyle = '#ffaa00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const len = 300;
            for(let x=-len/2;x<=len/2;x+=2){
                let y = 0;
                [1,2,3,4].forEach((n,i)=>{
                    y += (40/(n+1)) * Math.sin(n*Math.PI*(x+len/2)/len) * Math.sin(t*(5+n*2)+i);
                });
                x===-len/2 ? ctx.moveTo(cx+x,cy+y) : ctx.lineTo(cx+x,cy+y);
            }
            ctx.stroke();
            
            // Extra dimensions
            ctx.strokeStyle = 'rgba(100,100,255,0.2)';
            for(let i=0;i<6;i++){
                ctx.beginPath();
                ctx.ellipse(cx, cy, 30+i*25, 15+i*12, t*0.5+i*0.2, 0, Math.PI*2);
                ctx.stroke();
            }
        }
        
        function renderPlanck(t, cx, cy) {
            // Quantum foam
            const imageData = ctx.createImageData(width, height);
            for(let i=0;i<imageData.data.length;i+=4){
                const x = (i/4)%width, y = Math.floor((i/4)/width);
                const noise = Math.sin(x*0.1+t*5)*Math.cos(y*0.1+t*3)*Math.sin((x+y)*0.05+t*7);
                const v = Math.floor((noise+1)*50)+30;
                imageData.data[i] = v*0.5;
                imageData.data[i+1] = v*0.5;
                imageData.data[i+2] = v+80;
                imageData.data[i+3] = 255;
            }
            ctx.putImageData(imageData, 0, 0);
            
            // Central singularity
            const grad = ctx.createRadialGradient(cx,cy,0,cx,cy,150);
            grad.addColorStop(0,'rgba(255,255,255,0.9)');
            grad.addColorStop(0.3,'rgba(255,200,255,0.5)');
            grad.addColorStop(1,'rgba(100,50,200,0)');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(cx,cy,150,0,Math.PI*2); ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText('ℓₚ = 1.616 × 10⁻³⁵ m', cx, cy-20);
            ctx.font = '16px Courier New';
            ctx.fillText('THE PLANCK LENGTH', cx, cy+10);
            ctx.font = '12px Courier New';
            ctx.fillStyle = '#caa87e';
            ctx.fillText('Where space and time dissolve', cx, cy+40);
            ctx.fillText('CRR: Ω → ?', cx, cy+60);
        }
        
        function updateUI() {
            const info = getScaleInfo(currentScale);
            const logS = Math.log10(currentScale);
            const logMin = Math.log10(L_PLANCK);
            const logMax = Math.log10(2);
            const depth = ((logMax-logS)/(logMax-logMin))*100;
            
            document.getElementById('scaleName').textContent = info.name;
            document.getElementById('scaleDisplay').textContent = formatScale(currentScale);
            document.getElementById('scaleDesc').textContent = info.desc;
            
            const symClass = info.symmetry==='Z₂'?'symmetry-z2':info.symmetry==='SO(2)'?'symmetry-so2':'symmetry-planck';
            document.getElementById('symmetryDisplay').innerHTML = `<span class="${symClass}">${info.symmetry}</span>`;
            document.getElementById('omegaDisplay').textContent = info.symmetry==='Z₂'?'1/π = 0.318':info.symmetry==='SO(2)'?'1/2π = 0.159':'?';
            document.getElementById('tauDisplay').textContent = formatTime(info.tau);
            document.getElementById('freqDisplay').textContent = formatFreq(info.freq);
            
            document.getElementById('depthFill').style.width = depth+'%';
            document.getElementById('coherenceC').textContent = sessionCoherence.toFixed(4);
            
            const exp = Math.round(logS);
            const superscripts = '⁰¹²³⁴⁵⁶⁷⁸⁹';
            const expStr = String(Math.abs(exp)).split('').map(d=>superscripts[parseInt(d)]).join('');
            document.getElementById('zoomDepth').textContent = '10' + (exp<0?'⁻':'') + expStr;
            document.getElementById('rupturesPerSec').textContent = formatFreq(info.freq);
            
            // Chain
            const chainIdx = Math.min(CHAIN.length-1, Math.floor(depth/100*CHAIN.length));
            CHAIN.forEach((_,i)=>{
                const el = document.getElementById(`chain-${i}`);
                el.classList.remove('active','current');
                if(i<chainIdx) el.classList.add('active');
                if(i===chainIdx) el.classList.add('current');
            });
        }
        
        function animate(ts) {
            const t = (Date.now()-startTime)/1000;
            sessionCoherence += 1/60;
            
            currentScale += (targetScale-currentScale)*0.12;
            
            render(t);
            updateUI();
            
            requestAnimationFrame(animate);
        }
        
        window.onload = init;
    </script>
</body>
</html>
