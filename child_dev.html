<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRR Dynamics: Erikson & Piaget Visualisation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #cbd5e1;
        }

        .controls {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: centre;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-theory {
            background: #475569;
            color: #cbd5e1;
        }

        .btn-theory.active {
            background: #3b82f6;
            color: white;
        }

        .btn-theory:hover {
            background: #334155;
        }

        .btn-theory.active:hover {
            background: #2563eb;
        }

        .btn-play {
            background: #10b981;
            color: white;
        }

        .btn-play:hover {
            background: #059669;
        }

        .btn-reset {
            background: #475569;
            color: white;
        }

        .btn-reset:hover {
            background: #334155;
        }

        select {
            padding: 10px 15px;
            border-radius: 8px;
            background: #475569;
            color: white;
            border: 1px solid #334155;
            cursor: pointer;
        }

        .checkbox-label {
            display: flex;
            align-items: centre;
            gap: 8px;
            cursor: pointer;
        }

        input[type="range"] {
            width: 100%;
            margin-top: 10px;
        }

        .age-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 5px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #334155;
        }

        .card h2, .card h3 {
            margin-bottom: 15px;
        }

        #chartCanvas {
            width: 100%;
            height: 400px;
            border-radius: 8px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.875rem;
        }

        .legend-item {
            display: flex;
            align-items: centre;
            gap: 8px;
        }

        .legend-line {
            width: 20px;
            height: 3px;
        }

        .metric {
            margin-bottom: 20px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: 5px;
        }

        .metric-value {
            font-family: monospace;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #475569;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s;
            border-radius: 4px;
        }

        .stage-info {
            margin-bottom: 10px;
        }

        .stage-colour-bar {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .info-list {
            list-style: none;
            font-size: 0.875rem;
            color: #cbd5e1;
        }

        .info-list li {
            margin-bottom: 5px;
        }

        .pattern-list {
            list-style: none;
            font-size: 0.875rem;
            color: #cbd5e1;
        }

        .pattern-list li {
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative;
        }

        .pattern-list li:before {
            content: "•";
            position: absolute;
            left: 0;
        }

        .timeline {
            margin-top: 10px;
        }

        .timeline-bar {
            display: flex;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
        }

        .timeline-stage {
            display: flex;
            align-items: centre;
            justify-content: centre;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
            padding: 5px;
            text-align: centre;
        }

        .timeline-stage.active {
            box-shadow: inset 0 0 0 3px white;
        }

        .timeline-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .rupture-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            font-size: 0.75rem;
        }

        .rupture-btn {
            padding: 5px 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #991b1b;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .rupture-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .footer {
            text-align: centre;
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 30px;
        }

        .footer p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Coherence-Rupture-Regeneration Dynamics</h1>
            <p>Interactive visualisation of developmental stage transitions</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-row">
                <div class="button-group">
                    <button class="btn-theory active" id="btnErikson">Erikson (Psychosocial)</button>
                    <button class="btn-theory" id="btnPiaget">Piaget (Cognitive)</button>
                </div>

                <div class="button-group">
                    <button class="btn-play" id="btnPlay">▶ Play</button>
                    <button class="btn-reset" id="btnReset">↻ Reset</button>
                    
                    <select id="speedSelect">
                        <option value="0.5">0.5× Speed</option>
                        <option value="1" selected>1× Speed</option>
                        <option value="2">2× Speed</option>
                        <option value="5">5× Speed</option>
                    </select>

                    <label class="checkbox-label">
                        <input type="checkbox" id="showF" checked>
                        <span>Show Free Energy F(t)</span>
                    </label>
                </div>
            </div>

            <div>
                <input type="range" id="ageSlider" min="0" max="85" step="0.1" value="0">
                <div class="age-display">
                    <span>Age: <span id="currentAge">0.0</span> years</span>
                    <span>Max: <span id="maxAge">85</span> years</span>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Chart -->
            <div class="card">
                <h2 id="chartTitle">Erikson Developmental Trajectory</h2>
                <canvas id="chartCanvas"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-line" style="background: #3b82f6;"></div>
                        <span>Coherence C(t)</span>
                    </div>
                    <div class="legend-item" id="fLegend">
                        <div class="legend-line" style="background: #f59e0b;"></div>
                        <span>Free Energy F(t)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #ef4444; opacity: 0.5;"></div>
                        <span>Rupture δ(t)</span>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Current Stage -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3>Current Stage</h3>
                    <div class="stage-colour-bar" id="stageColourBar"></div>
                    <div id="stageInfo">
                        <p style="color: #94a3b8;">Development not yet started</p>
                    </div>
                </div>

                <!-- Current Metrics -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3>Current Metrics</h3>
                    <div class="metric">
                        <div class="metric-header">
                            <span>Coherence C(t)</span>
                            <span class="metric-value" style="color: #3b82f6;" id="coherenceValue">0.00</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="background: #3b82f6;" id="coherenceBar"></div>
                        </div>
                    </div>

                    <div class="metric" id="fMetric">
                        <div class="metric-header">
                            <span>Free Energy F(t)</span>
                            <span class="metric-value" style="color: #f59e0b;" id="freeEnergyValue">100.00</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="background: #f59e0b;" id="freeEnergyBar"></div>
                        </div>
                    </div>

                    <div style="padding-top: 10px; border-top: 1px solid #334155; margin-top: 10px;">
                        <p style="font-size: 0.75rem; color: #94a3b8;" id="patternNote">Power law frequency decay pattern</p>
                    </div>
                </div>

                <!-- Key Pattern -->
                <div class="card">
                    <h3 id="patternTitle">Erikson Pattern</h3>
                    <ul class="pattern-list" id="patternList">
                        <li>8 psychosocial stages (0-85y)</li>
                        <li>Power law frequency: f ∝ age^(-1.2)</li>
                        <li>Variable preservation: 30%→50%→70%</li>
                        <li>Modular architecture</li>
                        <li>Linear complexity growth</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="card">
            <h2>Stage Timeline</h2>
            <div class="timeline">
                <div class="timeline-bar" id="timelineBar"></div>
                <div class="timeline-markers" id="timelineMarkers"></div>
            </div>
            <div class="rupture-buttons">
                <span style="font-weight: 600;">Rupture points (δ):</span>
                <div id="ruptureButtons" style="display: contents;"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>CRR Framework: C(x,t) = ∫ L(x,τ) dτ | δ(t-t₀) | R[χ] = ∫ φ·e^(C/Ω)·Θ dτ</p>
            <p>Free Energy: F(C) = F₀/(1 + αC)^β where α=0.8, β=1.5</p>
        </div>
    </div>

    <script>
        // Data
        const eriksonStages = [
            { name: 'Trust vs Mistrust', start: 0, end: 1.5, colour: '#3b82f6', preservation: 0.30 },
            { name: 'Autonomy vs Shame', start: 1.5, end: 3, colour: '#8b5cf6', preservation: 0.30 },
            { name: 'Initiative vs Guilt', start: 3, end: 5, colour: '#ec4899', preservation: 0.35 },
            { name: 'Industry vs Inferiority', start: 5, end: 12, colour: '#f59e0b', preservation: 0.50 },
            { name: 'Identity vs Role Confusion', start: 12, end: 18, colour: '#10b981', preservation: 0.50 },
            { name: 'Intimacy vs Isolation', start: 18, end: 40, colour: '#06b6d4', preservation: 0.70 },
            { name: 'Generativity vs Stagnation', start: 40, end: 65, colour: '#8b5cf6', preservation: 0.70 },
            { name: 'Integrity vs Despair', start: 65, end: 85, colour: '#6366f1', preservation: 0.70 }
        ];

        const piagetStages = [
            { name: 'Sensorimotor', start: 0, end: 2, colour: '#3b82f6', preservation: 0.40 },
            { name: 'Preoperational', start: 2, end: 7, colour: '#8b5cf6', preservation: 0.60 },
            { name: 'Concrete Operational', start: 7, end: 12, colour: '#f59e0b', preservation: 0.75 },
            { name: 'Formal Operational', start: 12, end: 18, colour: '#10b981', preservation: null }
        ];

        // State
        let currentTheory = 'erikson';
        let currentAge = 0;
        let isPlaying = false;
        let playInterval = null;
        let speed = 1;
        let showFreeEnergy = true;

        // Elements
        const canvas = document.getElementById('chartCanvas');
        const ctx = canvas.getContext('2d');
        const ageSlider = document.getElementById('ageSlider');
        const currentAgeSpan = document.getElementById('currentAge');
        const maxAgeSpan = document.getElementById('maxAge');
        const btnPlay = document.getElementById('btnPlay');
        const btnReset = document.getElementById('btnReset');
        const btnErikson = document.getElementById('btnErikson');
        const btnPiaget = document.getElementById('btnPiaget');
        const speedSelect = document.getElementById('speedSelect');
        const showFCheckbox = document.getElementById('showF');

        // Helper functions
        function getStages() {
            return currentTheory === 'erikson' ? eriksonStages : piagetStages;
        }

        function getMaxAge() {
            return currentTheory === 'erikson' ? 85 : 18;
        }

        function calculateCoherence(age) {
            let C = 0;
            const L = 1.0;
            const stages = getStages();

            for (let i = 0; i < stages.length; i++) {
                const stage = stages[i];
                
                if (age <= stage.start) break;
                
                if (age >= stage.end) {
                    const duration = stage.end - stage.start;
                    C += duration * L;
                    if (i < stages.length - 1 && stage.preservation) {
                        C *= stage.preservation;
                    }
                } else {
                    const duration = age - stage.start;
                    C += duration * L;
                }
            }
            
            return C;
        }

        function calculateFreeEnergy(age) {
            const C = calculateCoherence(age);
            const F0 = 100;
            const alpha = 0.8;
            const beta = 1.5;
            
            let baseF = F0 / Math.pow(1 + alpha * C, beta);
            
            const stages = getStages();
            for (let stage of stages) {
                if (Math.abs(age - stage.end) < 0.5 && stage.preservation) {
                    return baseF + baseF * 0.5;
                }
            }
            
            return baseF;
        }

        function getCurrentStage() {
            const stages = getStages();
            return stages.find(s => currentAge >= s.start && currentAge < s.end);
        }

        // Drawing functions
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            drawChart();
        }

        function drawChart() {
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            const maxAge = getMaxAge();
            const stages = getStages();

            ctx.clearRect(0, 0, width, height);

            // Grid
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (i / 4) * height;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }

            // Stage backgrounds
            stages.forEach(stage => {
                const x = (stage.start / maxAge) * width;
                const w = ((stage.end - stage.start) / maxAge) * width;
                ctx.fillStyle = stage.colour + '1A';
                ctx.fillRect(x, 0, w, height);
            });

            // Rupture lines
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            stages.slice(0, -1).forEach(stage => {
                const x = (stage.end / maxAge) * width;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            });
            ctx.setLineDash([]);

            // Free Energy F(t)
            if (showFreeEnergy) {
                ctx.strokeStyle = '#f59e0b';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let age = 0; age <= maxAge; age += maxAge / 500) {
                    const F = calculateFreeEnergy(age);
                    const x = (age / maxAge) * width;
                    const y = height - (F / 100) * height;
                    if (age === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
            }

            // Coherence C(t)
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let age = 0; age <= maxAge; age += maxAge / 500) {
                const C = calculateCoherence(age);
                const x = (age / maxAge) * width;
                const y = height - (C / (maxAge * 0.65)) * height;
                if (age === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // Current position
            const C = calculateCoherence(currentAge);
            const x = (currentAge / maxAge) * width;
            const y = height - (C / (maxAge * 0.65)) * height;
            
            ctx.fillStyle = '#22c55e';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#94a3b8';
            ctx.font = '12px sans-serif';
            ctx.fillText('High', 10, 20);
            ctx.fillText('Low', 10, height - 10);
            ctx.fillText('Age →', width - 60, height - 10);
        }

        function updateUI() {
            const maxAge = getMaxAge();
            const stage = getCurrentStage();
            const C = calculateCoherence(currentAge);
            const F = calculateFreeEnergy(currentAge);

            // Update age display
            currentAgeSpan.textContent = currentAge.toFixed(1);
            maxAgeSpan.textContent = maxAge;
            ageSlider.max = maxAge;
            ageSlider.value = currentAge;

            // Update stage info
            const stageColourBar = document.getElementById('stageColourBar');
            const stageInfo = document.getElementById('stageInfo');
            
            if (stage) {
                stageColourBar.style.background = stage.colour;
                stageInfo.innerHTML = `
                    <p style="font-weight: 600; font-size: 1.125rem; margin-bottom: 10px;">${stage.name}</p>
                    <ul class="info-list">
                        <li>Age Range: ${stage.start} - ${stage.end} years</li>
                        <li>Duration: ${(stage.end - stage.start).toFixed(1)} years</li>
                        ${stage.preservation ? `<li>Preservation: ${(stage.preservation * 100).toFixed(0)}%</li>` : ''}
                    </ul>
                `;
            } else {
                stageColourBar.style.background = '#475569';
                stageInfo.innerHTML = '<p style="colour: #94a3b8;">Development complete</p>';
            }

            // Update metrics
            document.getElementById('coherenceValue').textContent = C.toFixed(2);
            document.getElementById('coherenceBar').style.width = `${Math.min((C / (maxAge * 0.65)) * 100, 100)}%`;
            
            if (showFreeEnergy) {
                document.getElementById('freeEnergyValue').textContent = F.toFixed(2);
                document.getElementById('freeEnergyBar').style.width = `${(F / 100) * 100}%`;
            }

            // Update timeline
            updateTimeline();
            
            // Redraw chart
            drawChart();
        }

        function updateTimeline() {
            const stages = getStages();
            const maxAge = getMaxAge();
            const timelineBar = document.getElementById('timelineBar');
            const stage = getCurrentStage();

            timelineBar.innerHTML = '';
            stages.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'timeline-stage';
                if (s === stage) div.classList.add('active');
                div.style.width = `${((s.end - s.start) / maxAge) * 100}%`;
                div.style.background = s.colour;
                div.style.opacity = currentAge >= s.start ? '1' : '0.3';
                div.textContent = s.name;
                div.onclick = () => {
                    currentAge = s.start + 0.1;
                    updateUI();
                };
                timelineBar.appendChild(div);
            });
        }

        function switchTheory(theory) {
            currentTheory = theory;
            currentAge = 0;
            
            btnErikson.classList.toggle('active', theory === 'erikson');
            btnPiaget.classList.toggle('active', theory === 'piaget');
            
            document.getElementById('chartTitle').textContent = 
                theory === 'erikson' ? 'Erikson Developmental Trajectory' : 'Piaget Developmental Trajectory';
            
            document.getElementById('patternTitle').textContent = 
                theory === 'erikson' ? 'Erikson Pattern' : 'Piaget Pattern';
            
            document.getElementById('patternNote').textContent = 
                theory === 'erikson' ? 'Power law frequency decay pattern' : 'Stabilised frequency pattern (~5 years)';
            
            const patternList = document.getElementById('patternList');
            if (theory === 'erikson') {
                patternList.innerHTML = `
                    <li>8 psychosocial stages (0-85y)</li>
                    <li>Power law frequency: f ∝ age^(-1.2)</li>
                    <li>Variable preservation: 30%→50%→70%</li>
                    <li>Modular architecture</li>
                    <li>Linear complexity growth</li>
                `;
            } else {
                patternList.innerHTML = `
                    <li>4 cognitive stages (0-18y)</li>
                    <li>Stabilised frequency: ~5-6 years</li>
                    <li>Monotonic preservation: 40%→75%</li>
                    <li>Hierarchical architecture</li>
                    <li>Exponential complexity: 2^n-1</li>
                `;
            }

            // Update rupture buttons
            const ruptureButtons = document.getElementById('ruptureButtons');
            const stages = getStages();
            ruptureButtons.innerHTML = '';
            stages.slice(0, -1).forEach((stage, i) => {
                const btn = document.createElement('button');
                btn.className = 'rupture-btn';
                btn.textContent = `${stage.end}y (${(stage.preservation * 100).toFixed(0)}% preserved)`;
                btn.onclick = () => {
                    currentAge = stage.end;
                    updateUI();
                };
                ruptureButtons.appendChild(btn);
            });

            // Update timeline markers
            const timelineMarkers = document.getElementById('timelineMarkers');
            if (theory === 'erikson') {
                timelineMarkers.innerHTML = '<span>0y</span><span>20y</span><span>40y</span><span>60y</span><span>85y</span>';
            } else {
                timelineMarkers.innerHTML = '<span>0y</span><span>6y</span><span>12y</span><span>18y</span>';
            }

            updateUI();
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            btnPlay.textContent = isPlaying ? '⏸ Pause' : '▶ Play';
            
            if (isPlaying) {
                playInterval = setInterval(() => {
                    currentAge += 0.1 * speed;
                    if (currentAge >= getMaxAge()) {
                        currentAge = getMaxAge();
                        togglePlay();
                    }
                    updateUI();
                }, 50);
            } else {
                clearInterval(playInterval);
            }
        }

        function reset() {
            currentAge = 0;
            if (isPlaying) togglePlay();
            updateUI();
        }

        function toggleFreeEnergy() {
            showFreeEnergy = showFCheckbox.checked;
            document.getElementById('fMetric').style.display = showFreeEnergy ? 'block' : 'none';
            document.getElementById('fLegend').style.display = showFreeEnergy ? 'flex' : 'none';
            updateUI();
        }

        // Event listeners
        btnErikson.onclick = () => switchTheory('erikson');
        btnPiaget.onclick = () => switchTheory('piaget');
        btnPlay.onclick = togglePlay;
        btnReset.onclick = reset;
        ageSlider.oninput = (e) => {
            currentAge = parseFloat(e.target.value);
            updateUI();
        };
        speedSelect.onchange = (e) => {
            speed = parseFloat(e.target.value);
        };
        showFCheckbox.onchange = toggleFreeEnergy;
        window.onresize = resizeCanvas;

        // Initialise
        resizeCanvas();
        switchTheory('erikson');
    </script>
</body>
</html>
