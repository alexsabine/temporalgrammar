<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRR Human Body | Physiologically Accurate Simulation</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #050608;
      --bg-secondary: #0a0d14;
      --bg-tertiary: #10141e;
      --bg-panel: rgba(10, 13, 20, 0.95);
      --border-color: rgba(255, 255, 255, 0.06);
      --border-accent: rgba(255, 255, 255, 0.12);
      --text-primary: #e8eaed;
      --text-secondary: rgba(232, 234, 237, 0.7);
      --text-muted: rgba(232, 234, 237, 0.35);
      --accent-red: #ef4444;
      --accent-blue: #3b82f6;
      --accent-cyan: #06b6d4;
      --accent-amber: #f59e0b;
      --accent-green: #22c55e;
      --accent-purple: #a855f7;
      --accent-orange: #f97316;
      --accent-pink: #ec4899;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'IBM Plex Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app { display: grid; grid-template-rows: auto 1fr auto; min-height: 100vh; }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0.6rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand { display: flex; align-items: center; gap: 0.75rem; }
    
    .logo {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, #06b6d4, #a855f7);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 0.7rem;
    }

    .title { font-size: 0.95rem; font-weight: 500; letter-spacing: -0.01em; }
    .subtitle { font-size: 0.6rem; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; }

    .header-metrics {
      display: flex; gap: 1.5rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
    }

    .metric { text-align: center; }
    .metric-label { color: var(--text-muted); font-size: 0.55rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .metric-value { color: var(--accent-cyan); font-weight: 500; margin-top: 0.15rem; }

    .controls { display: flex; gap: 0.5rem; }

    .btn {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.65rem;
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--border-accent);
      background: transparent;
      color: var(--text-primary);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex; align-items: center; gap: 0.3rem;
    }

    .btn:hover { background: rgba(255,255,255,0.03); border-color: var(--accent-cyan); }
    .btn.active { background: rgba(6,182,212,0.12); border-color: var(--accent-cyan); color: var(--accent-cyan); }

    /* Main */
    .main { display: grid; grid-template-columns: 260px 1fr 300px; overflow: hidden; }

    .panel {
      background: var(--bg-secondary);
      overflow-y: auto;
      display: flex; flex-direction: column;
    }

    .panel:first-child { border-right: 1px solid var(--border-color); }
    .panel:last-child { border-left: 1px solid var(--border-color); }

    .section { padding: 0.875rem; border-bottom: 1px solid var(--border-color); }
    .section:last-child { border-bottom: none; }

    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; }
    .section-title { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); font-weight: 500; }
    .section-badge { font-size: 0.55rem; padding: 0.1rem 0.35rem; background: rgba(255,255,255,0.04); border-radius: 3px; font-family: 'IBM Plex Mono', monospace; }

    /* View toggles */
    .view-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem; }
    
    .view-btn {
      padding: 0.5rem;
      background: rgba(0,0,0,0.25);
      border: 1px solid transparent;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
    }

    .view-btn:hover { background: rgba(255,255,255,0.02); }
    .view-btn.active { background: rgba(6,182,212,0.08); border-color: var(--accent-cyan); }
    .view-icon { font-size: 1.1rem; display: block; margin-bottom: 0.2rem; }
    .view-label { font-size: 0.55rem; color: var(--text-secondary); }

    /* Omega control */
    .omega-box { background: rgba(0,0,0,0.3); border-radius: 6px; padding: 0.875rem; }
    .omega-display { text-align: center; margin-bottom: 0.75rem; }
    .omega-symbol { font-size: 1.25rem; color: var(--accent-amber); font-weight: 300; }
    .omega-val { font-family: 'IBM Plex Mono', monospace; font-size: 1.5rem; font-weight: 600; color: var(--accent-amber); }
    .omega-eq { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; color: var(--text-muted); margin-top: 0.2rem; }

    .omega-slider {
      width: 100%; height: 5px;
      -webkit-appearance: none; appearance: none;
      background: linear-gradient(90deg, #3b82f6, #06b6d4, #f59e0b, #ef4444);
      border-radius: 3px; outline: none; cursor: pointer;
    }

    .omega-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px; height: 14px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .omega-labels { display: flex; justify-content: space-between; margin-top: 0.4rem; font-size: 0.55rem; color: var(--text-muted); }

    /* Cardiac */
    .cardiac-box { background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.15); border-radius: 6px; padding: 0.875rem; }
    .cardiac-top { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.6rem; }
    
    .heart-dot {
      width: 20px; height: 20px;
      background: var(--accent-red);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem;
      transition: transform 0.08s, box-shadow 0.08s;
    }

    .heart-dot.beat { transform: scale(1.25); box-shadow: 0 0 16px rgba(239,68,68,0.6); }

    .bpm { font-family: 'IBM Plex Mono', monospace; font-size: 1.2rem; font-weight: 600; color: var(--accent-red); }
    .bpm-label { font-size: 0.55rem; color: var(--text-muted); }

    .ecg-wave { height: 45px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
    .ecg-wave canvas { width: 100%; height: 100%; }

    .cardiac-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem; margin-top: 0.6rem; }
    .cardiac-stat { background: rgba(0,0,0,0.25); padding: 0.4rem; border-radius: 4px; text-align: center; }
    .cardiac-stat-val { font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; font-weight: 500; }
    .cardiac-stat-lbl { font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-top: 0.1rem; }

    /* Brain regions */
    .brain-list { display: flex; flex-direction: column; gap: 0.3rem; max-height: 180px; overflow-y: auto; }
    
    .brain-item {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.4rem; background: rgba(0,0,0,0.15); border-radius: 4px;
      font-size: 0.65rem;
    }

    .brain-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .brain-name { flex: 1; }
    .brain-band { font-family: 'IBM Plex Mono', monospace; font-size: 0.55rem; color: var(--text-muted); padding: 0.1rem 0.25rem; background: rgba(255,255,255,0.04); border-radius: 2px; }
    .brain-bar { width: 35px; height: 5px; background: rgba(0,0,0,0.3); border-radius: 3px; overflow: hidden; }
    .brain-bar-fill { height: 100%; border-radius: 3px; transition: width 0.1s; }

    /* Legend */
    .legend { display: grid; grid-template-columns: 1fr 1fr; gap: 0.35rem; }
    .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.6rem; color: var(--text-secondary); }
    .legend-line { width: 16px; height: 2px; border-radius: 1px; }

    /* Visualization */
    .viz-area {
      background: var(--bg-primary);
      background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(255,255,255,0.015) 19px, rgba(255,255,255,0.015) 20px),
        repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(255,255,255,0.015) 19px, rgba(255,255,255,0.015) 20px);
      display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
    }

    .svg-container { width: 100%; max-width: 480px; aspect-ratio: 1; position: relative; }
    #bodySvg { width: 100%; height: 100%; filter: drop-shadow(0 0 30px rgba(0,0,0,0.5)); }

    /* Overlays */
    .overlay {
      position: absolute;
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0.5rem 0.65rem;
      backdrop-filter: blur(8px);
    }

    .time-overlay { top: 0.75rem; left: 0.75rem; }
    .time-lbl { font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; }
    .time-val { font-family: 'IBM Plex Mono', monospace; font-size: 0.9rem; color: var(--accent-cyan); font-weight: 500; }

    .phase-overlay { bottom: 0.75rem; left: 0.75rem; width: 130px; height: 130px; padding: 0.4rem; }
    .phase-title { font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem; }
    .phase-canvas { width: 100%; height: calc(100% - 16px); background: rgba(0,0,0,0.3); border-radius: 4px; }

    .resp-overlay { bottom: 0.75rem; right: 0.75rem; width: 130px; }
    .resp-title { font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem; }
    .resp-canvas { width: 100%; height: 40px; background: rgba(0,0,0,0.3); border-radius: 4px; }
    .resp-rate { font-family: 'IBM Plex Mono', monospace; font-size: 0.7rem; color: var(--accent-cyan); margin-top: 0.25rem; }

    /* Right panel equations */
    .eq-card { background: rgba(0,0,0,0.3); border-radius: 5px; padding: 0.6rem; margin-bottom: 0.4rem; }
    
    .eq-line {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      padding: 0.3rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    .eq-line:last-child { border-bottom: none; }

    .eq-c { color: var(--accent-cyan); }
    .eq-d { color: var(--accent-orange); }
    .eq-r { color: var(--accent-green); }
    .eq-o { color: var(--accent-amber); }
    .eq-sym { color: var(--text-muted); }

    /* Waveforms */
    .wave-box { background: rgba(0,0,0,0.25); border-radius: 5px; padding: 0.6rem; margin-bottom: 0.5rem; }
    .wave-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem; }
    .wave-title { font-size: 0.6rem; font-weight: 500; display: flex; align-items: center; gap: 0.35rem; }
    .wave-dot { width: 5px; height: 5px; border-radius: 50%; }
    .wave-val { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; }
    .wave-canvas { width: 100%; height: 35px; background: rgba(0,0,0,0.3); border-radius: 3px; }

    /* Coherence graph */
    .coh-graph { height: 70px; background: rgba(0,0,0,0.25); border-radius: 5px; position: relative; overflow: hidden; }
    .coh-line { position: absolute; left: 0; right: 0; border-top: 1px dashed var(--accent-amber); opacity: 0.4; }
    .coh-label { position: absolute; right: 0.4rem; font-size: 0.45rem; color: var(--accent-amber); transform: translateY(-50%); }

    /* Metrics */
    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; }
    .metric-card { background: rgba(0,0,0,0.25); border-radius: 5px; padding: 0.5rem; text-align: center; }
    .metric-card-val { font-family: 'IBM Plex Mono', monospace; font-size: 0.9rem; font-weight: 600; }
    .metric-card-lbl { font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; margin-top: 0.15rem; }

    /* Physio panel */
    .physio-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.65rem; padding: 0.35rem 0.5rem; background: rgba(0,0,0,0.15); border-radius: 4px; margin-bottom: 0.3rem; }
    .physio-dot { width: 6px; height: 6px; border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .physio-text { flex: 1; color: var(--text-secondary); }
    .physio-val { font-family: 'IBM Plex Mono', monospace; font-size: 0.6rem; }

    /* Footer */
    .footer {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      padding: 0.4rem 1.25rem;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.6rem; color: var(--text-muted);
    }

    .footer-eq { font-family: 'IBM Plex Mono', monospace; }

    @media (max-width: 1200px) {
      .main { grid-template-columns: 220px 1fr 260px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="logo">CRR</div>
        <div>
          <div class="title">CRR Human Physiology</div>
          <div class="subtitle">Coherence-Rupture-Regeneration ‚Ä¢ Physiologically Accurate</div>
        </div>
      </div>
      
      <div class="header-metrics">
        <div class="metric">
          <div class="metric-label">Œ© Base</div>
          <div class="metric-value" id="hdrOmega">0.3183</div>
        </div>
        <div class="metric">
          <div class="metric-label">Ruptures</div>
          <div class="metric-value" id="hdrRuptures">0</div>
        </div>
        <div class="metric">
          <div class="metric-label">HRV (ms)</div>
          <div class="metric-value" id="hdrHRV">50</div>
        </div>
        <div class="metric">
          <div class="metric-label">Resp Rate</div>
          <div class="metric-value" id="hdrResp">12</div>
        </div>
      </div>
      
      <div class="controls">
        <button class="btn active" id="playBtn" onclick="toggleSim()">
          <span id="playIcon">‚ñ∂</span>
          <span id="playLbl">Running</span>
        </button>
        <button class="btn" onclick="resetSim()">‚Ü∫ Reset</button>
      </div>
    </header>

    <main class="main">
      <!-- Left Panel -->
      <aside class="panel">
        <div class="section">
          <div class="section-header">
            <span class="section-title">View Mode</span>
          </div>
          <div class="view-grid">
            <div class="view-btn active" data-mode="both" onclick="setView('both')">
              <span class="view-icon">üî¨</span>
              <span class="view-label">Both</span>
            </div>
            <div class="view-btn" data-mode="circ" onclick="setView('circ')">
              <span class="view-icon">‚ù§Ô∏è</span>
              <span class="view-label">Blood</span>
            </div>
            <div class="view-btn" data-mode="neuro" onclick="setView('neuro')">
              <span class="view-icon">üß†</span>
              <span class="view-label">Neural</span>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-title">Œ© Modulation</span>
            <span class="section-badge">= 1/œÄ</span>
          </div>
          <div class="omega-box">
            <div class="omega-display">
              <span class="omega-symbol">Œ©</span>
              <span class="omega-val" id="omegaVal">0.3183</span>
              <div class="omega-eq">Œ© = 1/œÄ ‚âà 0.31831 (inverse precision)</div>
            </div>
            <input type="range" class="omega-slider" id="omegaSlider" 
                   min="0.1" max="1.0" step="0.01" value="0.3183" 
                   oninput="setOmega(this.value)">
            <div class="omega-labels">
              <span>Rigid (Low œÄ)</span>
              <span>Fluid (High œÄ)</span>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-title">Cardiac Monitor</span>
            <span class="section-badge" id="cardState">DIASTOLE</span>
          </div>
          <div class="cardiac-box">
            <div class="cardiac-top">
              <div class="heart-dot" id="heartDot">‚ù§</div>
              <div>
                <div class="bpm"><span id="bpmVal">72</span> <span style="font-size:0.6rem;opacity:0.6">BPM</span></div>
                <div class="bpm-label">Instantaneous Heart Rate</div>
              </div>
            </div>
            <div class="ecg-wave">
              <canvas id="ecgCanvas"></canvas>
            </div>
            <div class="cardiac-grid">
              <div class="cardiac-stat">
                <div class="cardiac-stat-val" id="systolicBP">120</div>
                <div class="cardiac-stat-lbl">Systolic</div>
              </div>
              <div class="cardiac-stat">
                <div class="cardiac-stat-val" id="diastolicBP">80</div>
                <div class="cardiac-stat-lbl">Diastolic</div>
              </div>
              <div class="cardiac-stat">
                <div class="cardiac-stat-val" id="cardCoh">0.00</div>
                <div class="cardiac-stat-lbl">C(t)</div>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-title">Brain Regions</span>
            <span class="section-badge">8 Cortical Zones</span>
          </div>
          <div class="brain-list" id="brainList"></div>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-title">Legend</span>
          </div>
          <div class="legend">
            <div class="legend-item"><div class="legend-line" style="background:#ef4444"></div>Arteries</div>
            <div class="legend-item"><div class="legend-line" style="background:#3b82f6"></div>Veins</div>
            <div class="legend-item"><div class="legend-line" style="background:#f97316"></div>Motor</div>
            <div class="legend-item"><div class="legend-line" style="background:#22c55e"></div>Sensory</div>
            <div class="legend-item"><div class="legend-line" style="background:#06b6d4"></div>Parasym</div>
            <div class="legend-item"><div class="legend-line" style="background:#f59e0b"></div>Sympath</div>
          </div>
        </div>
      </aside>

      <!-- Visualization -->
      <div class="viz-area">
        <div class="overlay time-overlay">
          <div class="time-lbl">Simulation Time</div>
          <div class="time-val" id="timeVal">t = 0.00s</div>
        </div>

        <div class="svg-container">
          <svg id="bodySvg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
            <defs>
              <radialGradient id="heartGlow">
                <stop offset="0%" stop-color="#ef4444" stop-opacity="0.7"/>
                <stop offset="100%" stop-color="#ef4444" stop-opacity="0"/>
              </radialGradient>
              <radialGradient id="brainGlow">
                <stop offset="0%" stop-color="#f59e0b" stop-opacity="0.35"/>
                <stop offset="100%" stop-color="#f59e0b" stop-opacity="0"/>
              </radialGradient>
              <filter id="glow"><feGaussianBlur stdDeviation="0.6" result="blur"/><feComposite in="SourceGraphic" in2="blur" operator="over"/></filter>
            </defs>

            <!-- Body outline -->
            <g id="bodyOutline" opacity="0.2" stroke="#3a5a8a" stroke-width="0.35" fill="none">
              <ellipse cx="50" cy="10" rx="9" ry="11"/>
              <rect x="46" y="20" width="8" height="5" rx="1"/>
              <path d="M33 25 Q30 32 30 45 Q30 58 35 65 L45 68 L55 68 L65 65 Q70 58 70 45 Q70 32 67 25 Z"/>
              <path d="M30 28 Q22 32 18 45 Q15 55 18 62" stroke-width="5" stroke-linecap="round"/>
              <path d="M70 28 Q78 32 82 45 Q85 55 82 62" stroke-width="5" stroke-linecap="round"/>
              <ellipse cx="18" cy="64" rx="4" ry="5"/>
              <ellipse cx="82" cy="64" rx="4" ry="5"/>
              <path d="M42 68 L40 80 L38 95" stroke-width="6" stroke-linecap="round"/>
              <path d="M58 68 L60 80 L62 95" stroke-width="6" stroke-linecap="round"/>
            </g>

            <g id="circSystem"></g>
            <g id="neuroSystem"></g>
            <g id="heartGroup">
              <circle id="heartGlowC" cx="50" cy="32" r="5" fill="url(#heartGlow)" opacity="0.3"/>
              <circle id="heartCore" cx="50" cy="32" r="3.5" fill="#ef4444"/>
              <text x="50" y="33" text-anchor="middle" font-size="2.2" fill="white">‚ù§</text>
            </g>
            <g id="bloodParts"></g>
            <g id="neuroParts"></g>
            <g id="brainParts"></g>
          </svg>
        </div>

        <div class="overlay phase-overlay">
          <div class="phase-title">Phase Space (C, dC/dt)</div>
          <canvas id="phaseCanvas" class="phase-canvas"></canvas>
        </div>

        <div class="overlay resp-overlay">
          <div class="resp-title">Respiration</div>
          <canvas id="respCanvas" class="resp-canvas"></canvas>
          <div class="resp-rate"><span id="respRateVal">12</span> breaths/min</div>
        </div>
      </div>

      <!-- Right Panel -->
      <aside class="panel">
        <div class="section">
          <div class="section-header">
            <span class="section-title">CRR Framework</span>
            <span class="section-badge">Active</span>
          </div>
          <div class="eq-card">
            <div class="eq-line"><span class="eq-c">C(x,t)</span> <span class="eq-sym">=</span> ‚à´<sub>0</sub><sup>t</sup>L(x,œÑ)dœÑ</div>
            <div class="eq-line"><span class="eq-d">Œ¥(now)</span> <span class="eq-sym">when</span> C ‚â• <span class="eq-o">Œ©</span></div>
            <div class="eq-line"><span class="eq-r">R</span> <span class="eq-sym">=</span> ‚à´œÜ(œÑ)¬∑exp(C/<span class="eq-o">Œ©</span>)¬∑ŒòdœÑ</div>
          </div>
          <div class="eq-card">
            <div class="eq-line"><span class="eq-o">Œ©</span> <span class="eq-sym">=</span> 1/œÄ <span class="eq-sym">(inverse precision)</span></div>
            <div class="eq-line">exp(C/<span class="eq-o">Œ©</span>) <span class="eq-sym">‚Üí</span> memory weighting</div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-title">EEG Bands</span>
          </div>
          
          <div class="wave-box">
            <div class="wave-head">
              <span class="wave-title"><span class="wave-dot" style="background:#a855f7"></span>Theta (4-8 Hz)</span>
              <span class="wave-val" style="color:#a855f7" id="thetaVal">0.00</span>
            </div>
            <canvas id="thetaCanvas" class="wave-canvas"></canvas>
          </div>

          <div class="wave-box">
            <div class="wave-head">
              <span class="wave-title"><span class="wave-dot" style="background:#22c55e"></span>Alpha (8-13 Hz)</span>
              <span class="wave-val" style="color:#22c55e" id="alphaVal">0.00</span>
            </div>
            <canvas id="alphaCanvas" class="wave-canvas"></canvas>
          </div>

          <div class="wave-box">
            <div class="wave-head">
              <span class="wave-title"><span class="wave-dot" style="background:#06b6d4"></span>Gamma (30+ Hz)</span>
              <span class="wave-val" style="color:#06b6d4" id="gammaVal">0.00</span>
            </div>
            <canvas id="gammaCanvas" class="wave-canvas"></canvas>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-title">Coherence C(t)</span>
          </div>
          <div class="coh-graph">
            <canvas id="cohCanvas" style="width:100%;height:100%"></canvas>
            <div class="coh-line" id="cohLine" style="top:25%"><span class="coh-label">Œ©</span></div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-title">CRR Metrics</span>
          </div>
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-card-val" style="color:var(--accent-cyan)" id="avgCoh">0.000</div>
              <div class="metric-card-lbl">Mean C(t)</div>
            </div>
            <div class="metric-card">
              <div class="metric-card-val" style="color:var(--accent-orange)" id="rupRate">0.0</div>
              <div class="metric-card-lbl">Œ¥/min</div>
            </div>
            <div class="metric-card">
              <div class="metric-card-val" style="color:var(--accent-green)" id="regenIdx">1.00</div>
              <div class="metric-card-lbl">R Index</div>
            </div>
            <div class="metric-card">
              <div class="metric-card-val" style="color:var(--accent-amber)" id="expWt">2.72</div>
              <div class="metric-card-lbl">exp(C/Œ©)</div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <span class="section-title">Physiological Coupling</span>
          </div>
          <div class="physio-item">
            <div class="physio-dot" style="background:var(--accent-cyan)"></div>
            <span class="physio-text">Vagal ‚Üí HRV modulation</span>
            <span class="physio-val" id="vagalPct">85%</span>
          </div>
          <div class="physio-item">
            <div class="physio-dot" style="background:var(--accent-orange)"></div>
            <span class="physio-text">Resp ‚Üí RSA coupling</span>
            <span class="physio-val" id="rsaPct">72%</span>
          </div>
          <div class="physio-item">
            <div class="physio-dot" style="background:var(--accent-red)"></div>
            <span class="physio-text">Baroreceptor reflex</span>
            <span class="physio-val" id="baroPct">91%</span>
          </div>
          <div class="physio-item">
            <div class="physio-dot" style="background:var(--accent-purple)"></div>
            <span class="physio-text">Cortical ‚Üí Autonomic</span>
            <span class="physio-val" id="cortAutoPct">68%</span>
          </div>
        </div>
      </aside>
    </main>

    <footer class="footer">
      <div>Cohere Research ‚Ä¢ cohere.org.uk</div>
      <div class="footer-eq">C(x,t) ‚Üí Œ¥(now) ‚Üí R(exp(C/Œ©)) | Œ© = 1/œÄ | Validated across 7 domains</div>
      <div>CRR Framework ¬© 2025</div>
    </footer>
  </div>

<script>
// ============================================================================
// PHYSIOLOGICALLY ACCURATE CRR SIMULATION
// ============================================================================

const OMEGA_BASE = 1 / Math.PI; // ~0.31831
let omega = OMEGA_BASE;
let running = true;
let simTime = 0;
let totalRuptures = 0;
let viewMode = 'both';

// ============================================================================
// PHYSIOLOGICAL CONSTANTS (Evidence-based values)
// ============================================================================
const PHYSIO = {
  // Cardiac (resting adult)
  HR_BASE: 72,           // BPM
  HR_MIN: 55,
  HR_MAX: 100,
  SYSTOLE_FRAC: 0.35,    // 35% of cardiac cycle
  BP_SYSTOLIC: 120,
  BP_DIASTOLIC: 80,
  
  // Respiration
  RESP_RATE: 12,         // breaths/min
  RESP_PERIOD: 5,        // seconds per breath
  RSA_AMPLITUDE: 8,      // BPM variation from RSA
  
  // Blood flow velocities (m/s, scaled to visualization)
  FLOW_AORTA: 1.0,       // ~1 m/s
  FLOW_ARTERY: 0.4,      // ~40 cm/s
  FLOW_VEIN: 0.15,       // ~15 cm/s
  FLOW_CAPILLARY: 0.001, // ~0.5 mm/s
  
  // Neural conduction (m/s)
  COND_MOTOR: 60,        // 50-70 m/s (AŒ± fibers)
  COND_SENSORY: 50,      // 30-70 m/s (AŒ≤ fibers)
  COND_AUTONOMIC: 5,     // 1-20 m/s (B/C fibers)
  
  // EEG frequencies (Hz)
  DELTA: { min: 0.5, max: 4 },
  THETA: { min: 4, max: 8 },
  ALPHA: { min: 8, max: 13 },
  BETA: { min: 13, max: 30 },
  GAMMA: { min: 30, max: 100 }
};

// ============================================================================
// CRR SYSTEM CLASS - Rigorous Implementation
// ============================================================================
class CRRSystem {
  constructor(omega, frequency, name = '') {
    this.omega = omega;
    this.frequency = frequency;
    this.name = name;
    
    // Core CRR state
    this.coherence = 0;              // C(x,t) - accumulated coherence
    this.coherenceHistory = [];       // Full history for regeneration
    this.state = 'coherence';        // coherence | rupture | regeneration
    this.phase = Math.random() * 2 * Math.PI;
    this.amplitude = 0;
    this.ruptureCount = 0;
    this.lastRuptureTime = -Infinity;
    
    // For derivatives
    this.dCdt = 0;
    this.lastC = 0;
    
    // Living function accumulator
    this.livingIntegral = 0;
    
    // Regeneration memory
    this.memoryWeights = [];
  }

  // L(x,t) - the "living" function representing moment-to-moment experience
  livingFunction(t, externalInput = 0) {
    // Sinusoidal base with external modulation
    const base = Math.sin(2 * Math.PI * this.frequency * t + this.phase);
    // Rectified to be non-negative (only positive experiences accumulate)
    const rectified = Math.max(0, base + externalInput);
    return rectified;
  }

  // Compute exponential memory weighting for regeneration
  computeMemoryWeight(historicalC) {
    // exp(C/Œ©) - higher past coherence = stronger memory weight
    return Math.exp(historicalC / this.omega);
  }

  // Select regeneration state based on exp(C/Œ©) weighted history
  selectRegenerationState() {
    if (this.coherenceHistory.length === 0) return 0;
    
    // Weight each historical moment by exp(C/Œ©)
    let totalWeight = 0;
    let weightedSum = 0;
    
    this.coherenceHistory.forEach((c, i) => {
      const weight = this.computeMemoryWeight(c);
      totalWeight += weight;
      weightedSum += c * weight;
    });
    
    // Return weighted average of historical coherence
    return totalWeight > 0 ? weightedSum / totalWeight : 0;
  }

  update(dt, t, externalInput = 0) {
    this.lastC = this.coherence;
    
    switch (this.state) {
      case 'coherence':
        // C(x,t) = ‚à´L(x,œÑ)dœÑ - accumulate living function
        const living = this.livingFunction(t, externalInput);
        this.livingIntegral += living * dt;
        this.coherence = this.livingIntegral;
        
        // Store history for regeneration phase
        this.coherenceHistory.push(this.coherence);
        if (this.coherenceHistory.length > 500) {
          this.coherenceHistory.shift();
        }
        
        // Rupture trigger: Œ¥(now) when C ‚â• Œ©
        if (this.coherence >= this.omega) {
          this.state = 'rupture';
          this.ruptureCount++;
          totalRuptures++;
          this.lastRuptureTime = t;
        }
        break;
        
      case 'rupture':
        // Œ¥(now) - instantaneous rupture (Dirac delta)
        // Coherence resets, but memory persists
        this.coherence = 0;
        this.livingIntegral = 0;
        this.state = 'regeneration';
        break;
        
      case 'regeneration':
        // R = ‚à´œÜ(œÑ)¬∑exp(C/Œ©)¬∑ŒòdœÑ
        // Regeneration draws from exp(C/Œ©) weighted past
        const targetC = this.selectRegenerationState();
        const regenRate = 0.3 / this.omega; // Faster regen with low Œ©
        
        this.coherence += regenRate * dt;
        this.livingIntegral = this.coherence;
        
        // Exit regeneration when we've recovered enough coherence
        if (this.coherence > this.omega * 0.25) {
          this.state = 'coherence';
        }
        break;
    }
    
    // Compute derivative for phase space
    this.dCdt = (this.coherence - this.lastC) / Math.max(dt, 0.001);
    
    // Compute amplitude for visualization
    this.amplitude = this.state === 'rupture' ? 1.0 :
                     Math.abs(Math.sin(this.phase)) * (0.3 + 0.7 * (this.coherence / this.omega));
    
    this.phase += 2 * Math.PI * this.frequency * dt;
    
    return this;
  }

  setOmega(newOmega) {
    this.omega = newOmega;
  }
  
  getExpWeight() {
    return Math.exp(this.coherence / this.omega);
  }
}

// ============================================================================
// ANATOMICAL DEFINITIONS
// ============================================================================
const VESSELS = {
  // Major arteries with diameter-based flow velocities
  aorta: { type: 'artery', path: [[50,32],[50,35]], color: '#ef4444', diam: 2.5, flowMult: 1.0 },
  aortic_arch: { type: 'artery', path: [[50,35],[48,30],[46,26]], color: '#ef4444', diam: 2.2, flowMult: 0.9 },
  desc_aorta: { type: 'artery', path: [[50,35],[50,40],[50,45],[50,50],[50,55]], color: '#ef4444', diam: 2.0, flowMult: 0.8 },
  
  // Head
  r_carotid: { type: 'artery', path: [[52,28],[54,22],[54,16],[53,12]], color: '#f87171', diam: 0.8, flowMult: 0.5 },
  l_carotid: { type: 'artery', path: [[48,28],[46,22],[46,16],[47,12]], color: '#f87171', diam: 0.8, flowMult: 0.5 },
  
  // Arms
  r_subcl: { type: 'artery', path: [[52,28],[58,28],[65,30]], color: '#f87171', diam: 1.0, flowMult: 0.6 },
  l_subcl: { type: 'artery', path: [[48,28],[42,28],[35,30]], color: '#f87171', diam: 1.0, flowMult: 0.6 },
  r_brach: { type: 'artery', path: [[65,30],[70,38],[74,48]], color: '#fca5a5', diam: 0.6, flowMult: 0.4 },
  l_brach: { type: 'artery', path: [[35,30],[30,38],[26,48]], color: '#fca5a5', diam: 0.6, flowMult: 0.4 },
  r_radial: { type: 'artery', path: [[74,48],[77,54],[79,60]], color: '#fecaca', diam: 0.4, flowMult: 0.3 },
  l_radial: { type: 'artery', path: [[26,48],[23,54],[21,60]], color: '#fecaca', diam: 0.4, flowMult: 0.3 },
  
  // Torso
  celiac: { type: 'artery', path: [[50,40],[45,42],[40,43]], color: '#fca5a5', diam: 0.8, flowMult: 0.5 },
  r_renal: { type: 'artery', path: [[50,44],[56,45],[60,45]], color: '#fca5a5', diam: 0.6, flowMult: 0.4 },
  l_renal: { type: 'artery', path: [[50,44],[44,45],[40,45]], color: '#fca5a5', diam: 0.6, flowMult: 0.4 },
  
  // Legs
  r_iliac: { type: 'artery', path: [[50,55],[54,58],[57,62]], color: '#f87171', diam: 1.0, flowMult: 0.6 },
  l_iliac: { type: 'artery', path: [[50,55],[46,58],[43,62]], color: '#f87171', diam: 1.0, flowMult: 0.6 },
  r_femoral: { type: 'artery', path: [[57,62],[59,70],[60,78]], color: '#fca5a5', diam: 0.8, flowMult: 0.45 },
  l_femoral: { type: 'artery', path: [[43,62],[41,70],[40,78]], color: '#fca5a5', diam: 0.8, flowMult: 0.45 },
  r_tibial: { type: 'artery', path: [[60,78],[61,86],[62,94]], color: '#fecaca', diam: 0.5, flowMult: 0.3 },
  l_tibial: { type: 'artery', path: [[40,78],[39,86],[38,94]], color: '#fecaca', diam: 0.5, flowMult: 0.3 },
  
  // Pulmonary (special - deoxy to lungs, oxy back)
  pulm_art: { type: 'artery', path: [[48,32],[44,28],[42,26]], color: '#6366f1', diam: 2.0, flowMult: 0.8, deoxy: true },
  pulm_vein: { type: 'vein', path: [[42,26],[44,30],[48,32]], color: '#f87171', diam: 1.8, flowMult: 0.6, oxy: true },
  
  // Major veins
  svc: { type: 'vein', path: [[52,24],[52,28],[52,32]], color: '#3b82f6', diam: 2.0, flowMult: 0.5 },
  ivc: { type: 'vein', path: [[52,55],[52,48],[52,40],[52,32]], color: '#3b82f6', diam: 2.5, flowMult: 0.55 },
  
  r_jugular: { type: 'vein', path: [[56,12],[56,18],[54,24]], color: '#60a5fa', diam: 0.8, flowMult: 0.35 },
  l_jugular: { type: 'vein', path: [[44,12],[44,18],[46,24]], color: '#60a5fa', diam: 0.8, flowMult: 0.35 },
  
  r_arm_v: { type: 'vein', path: [[80,60],[76,50],[70,40],[64,32],[56,28]], color: '#93c5fd', diam: 0.5, flowMult: 0.25 },
  l_arm_v: { type: 'vein', path: [[20,60],[24,50],[30,40],[36,32],[44,28]], color: '#93c5fd', diam: 0.5, flowMult: 0.25 },
  
  r_leg_v: { type: 'vein', path: [[64,94],[63,85],[61,75],[58,65],[54,58]], color: '#93c5fd', diam: 0.6, flowMult: 0.3 },
  l_leg_v: { type: 'vein', path: [[36,94],[37,85],[39,75],[42,65],[46,58]], color: '#93c5fd', diam: 0.6, flowMult: 0.3 },
};

const BRAIN_REGIONS = {
  prefrontal: { pos: [50, 6], color: '#a855f7', freq: 6, band: 'Œ∏', label: 'Prefrontal' },
  motor_l: { pos: [44, 8], color: '#f97316', freq: 22, band: 'Œ≤', label: 'Motor L' },
  motor_r: { pos: [56, 8], color: '#f97316', freq: 22, band: 'Œ≤', label: 'Motor R' },
  sensory_l: { pos: [43, 10], color: '#22c55e', freq: 10, band: 'Œ±', label: 'Sensory L' },
  sensory_r: { pos: [57, 10], color: '#22c55e', freq: 10, band: 'Œ±', label: 'Sensory R' },
  visual: { pos: [50, 14], color: '#06b6d4', freq: 45, band: 'Œ≥', label: 'Visual' },
  brainstem: { pos: [50, 18], color: '#f59e0b', freq: 2, band: 'Œ¥', label: 'Brainstem' },
  cerebellum: { pos: [50, 16], color: '#ec4899', freq: 40, band: 'Œ≥', label: 'Cerebellum' },
};

const NEURAL_PATHS = {
  // Motor (descending) - fast conduction
  motor_r_arm: { type: 'motor', path: [[44,8],[46,14],[50,20],[52,24],[58,28],[68,38],[76,52],[80,62]], color: '#f97316', condVel: PHYSIO.COND_MOTOR },
  motor_l_arm: { type: 'motor', path: [[56,8],[54,14],[50,20],[48,24],[42,28],[32,38],[24,52],[20,62]], color: '#f97316', condVel: PHYSIO.COND_MOTOR },
  motor_r_leg: { type: 'motor', path: [[44,8],[46,14],[50,22],[50,35],[50,48],[54,58],[58,72],[61,88]], color: '#f97316', condVel: PHYSIO.COND_MOTOR },
  motor_l_leg: { type: 'motor', path: [[56,8],[54,14],[50,22],[50,35],[50,48],[46,58],[42,72],[39,88]], color: '#f97316', condVel: PHYSIO.COND_MOTOR },
  
  // Sensory (ascending)
  sens_r_arm: { type: 'sensory', path: [[80,62],[76,52],[68,38],[58,28],[52,24],[50,20],[46,14],[43,10]], color: '#22c55e', condVel: PHYSIO.COND_SENSORY },
  sens_l_arm: { type: 'sensory', path: [[20,62],[24,52],[32,38],[42,28],[48,24],[50,20],[54,14],[57,10]], color: '#22c55e', condVel: PHYSIO.COND_SENSORY },
  sens_r_leg: { type: 'sensory', path: [[61,88],[58,72],[54,58],[50,48],[50,35],[50,22],[46,14],[43,10]], color: '#22c55e', condVel: PHYSIO.COND_SENSORY },
  sens_l_leg: { type: 'sensory', path: [[39,88],[42,72],[46,58],[50,48],[50,35],[50,22],[54,14],[57,10]], color: '#22c55e', condVel: PHYSIO.COND_SENSORY },
  
  // Autonomic - slow conduction
  vagus: { type: 'parasym', path: [[50,18],[50,22],[50,26],[50,32]], color: '#06b6d4', condVel: PHYSIO.COND_AUTONOMIC },
  sympathetic: { type: 'sym', path: [[50,18],[48,22],[46,26],[48,30],[50,32]], color: '#f59e0b', condVel: PHYSIO.COND_AUTONOMIC },
  vagus_gi: { type: 'parasym', path: [[50,18],[50,26],[50,35],[48,42],[45,48]], color: '#06b6d4', condVel: PHYSIO.COND_AUTONOMIC },
};

// ============================================================================
// SIMULATION STATE
// ============================================================================
const systems = {
  heart: new CRRSystem(OMEGA_BASE * 1.2, 1.2, 'cardiac'),
  respiration: new CRRSystem(OMEGA_BASE * 0.8, 0.2, 'resp'),
  brain: {},
  baroreceptor: new CRRSystem(OMEGA_BASE * 1.5, 0.5, 'baro')
};

let bloodParts = [];
let neuroParts = [];
let brainStates = {};

// Physiological state
let cardiacCycle = { phase: 0, isSystole: false, lastBeatTime: 0, rr_intervals: [] };
let respCycle = { phase: 0, amplitude: 0 };

// Waveform histories
const waves = {
  ecg: [],
  theta: [],
  alpha: [],
  gamma: [],
  coherence: [],
  phase: [],
  resp: []
};

// ============================================================================
// INITIALIZATION
// ============================================================================
function init() {
  // Brain systems
  Object.entries(BRAIN_REGIONS).forEach(([k, r]) => {
    systems.brain[k] = new CRRSystem(OMEGA_BASE * 1.8, r.freq, k);
  });
  
  // Blood particles with velocity-based speeds
  Object.entries(VESSELS).forEach(([name, v]) => {
    const nParts = v.type === 'artery' ? 3 : 2;
    for (let i = 0; i < nParts; i++) {
      bloodParts.push({
        vessel: name,
        progress: Math.random(),
        speed: 0.008 * v.flowMult * (0.8 + Math.random() * 0.4),
        isArtery: v.type === 'artery'
      });
    }
  });
  
  // Neural signals with conduction-velocity-based speeds
  Object.entries(NEURAL_PATHS).forEach(([name, p]) => {
    neuroParts.push({
      pathway: name,
      progress: Math.random(),
      speed: 0.015 * (p.condVel / PHYSIO.COND_MOTOR),
      active: true
    });
  });
  
  drawVessels();
  drawNeuroPaths();
  drawBrainRegions();
  populateBrainList();
  setupCanvases();
  
  requestAnimationFrame(animate);
}

function setupCanvases() {
  ['ecgCanvas', 'thetaCanvas', 'alphaCanvas', 'gammaCanvas', 'cohCanvas', 'phaseCanvas', 'respCanvas'].forEach(id => {
    const c = document.getElementById(id);
    if (c) {
      const r = c.parentElement.getBoundingClientRect();
      c.width = r.width * 2;
      c.height = r.height * 2;
    }
  });
}

// ============================================================================
// DRAWING
// ============================================================================
function drawVessels() {
  const g = document.getElementById('circSystem');
  g.innerHTML = '';
  
  // Lungs
  g.innerHTML += `
    <ellipse cx="42" cy="28" rx="5" ry="4" fill="none" stroke="#93c5fd" stroke-width="0.25" stroke-dasharray="1,1" opacity="0.35"/>
    <ellipse cx="58" cy="28" rx="5" ry="4" fill="none" stroke="#93c5fd" stroke-width="0.25" stroke-dasharray="1,1" opacity="0.35"/>
    <text x="42" y="28.5" text-anchor="middle" font-size="2.2" fill="#93c5fd" opacity="0.5">ü´Å</text>
    <text x="58" y="28.5" text-anchor="middle" font-size="2.2" fill="#93c5fd" opacity="0.5">ü´Å</text>
  `;
  
  Object.entries(VESSELS).forEach(([name, v]) => {
    const d = v.path.map((p, i) => `${i === 0 ? 'M' : 'L'}${p[0]},${p[1]}`).join(' ');
    g.innerHTML += `
      <path d="${d}" stroke="${v.color}" stroke-width="${v.diam * 1.5}" fill="none" opacity="0.12" stroke-linecap="round"/>
      <path d="${d}" stroke="${v.color}" stroke-width="${v.diam * 0.65}" fill="none" opacity="0.75" stroke-linecap="round"/>
    `;
  });
}

function drawNeuroPaths() {
  const g = document.getElementById('neuroSystem');
  g.innerHTML = '';
  
  // Brain glow
  g.innerHTML += `<ellipse cx="50" cy="10" rx="11" ry="13" fill="url(#brainGlow)" opacity="0.45"/>`;
  
  // Spinal cord
  g.innerHTML += `<path d="M50,20 L50,60" stroke="#f59e0b" stroke-width="1" opacity="0.45" stroke-linecap="round"/>`;
  
  Object.entries(NEURAL_PATHS).forEach(([name, p]) => {
    const d = p.path.map((pt, i) => `${i === 0 ? 'M' : 'L'}${pt[0]},${pt[1]}`).join(' ');
    const dash = p.type === 'sensory' ? 'stroke-dasharray="2,1"' : '';
    g.innerHTML += `<path d="${d}" stroke="${p.color}" stroke-width="0.45" fill="none" opacity="0.3" stroke-linecap="round" ${dash}/>`;
  });
  
  // Nerve endings
  [[80,62],[20,62],[62,95],[38,95]].forEach(([x, y]) => {
    g.innerHTML += `
      <circle cx="${x}" cy="${y}" r="1.4" fill="#22c55e" opacity="0.2"/>
      <circle cx="${x}" cy="${y}" r="0.7" fill="#22c55e" opacity="0.55"/>
    `;
  });
}

function drawBrainRegions() {
  const g = document.getElementById('brainParts');
  g.innerHTML = '';
  
  Object.entries(BRAIN_REGIONS).forEach(([k, r]) => {
    g.innerHTML += `
      <g id="brain-${k}">
        <circle class="br-outer" cx="${r.pos[0]}" cy="${r.pos[1]}" r="1.8" fill="${r.color}" opacity="0.18"/>
        <circle class="br-inner" cx="${r.pos[0]}" cy="${r.pos[1]}" r="0.9" fill="${r.color}" opacity="0.55"/>
      </g>
    `;
  });
}

function populateBrainList() {
  const list = document.getElementById('brainList');
  list.innerHTML = '';
  
  Object.entries(BRAIN_REGIONS).forEach(([k, r]) => {
    list.innerHTML += `
      <div class="brain-item" id="bl-${k}">
        <div class="brain-dot" style="background:${r.color}"></div>
        <span class="brain-name">${r.label}</span>
        <span class="brain-band">${r.band}</span>
        <div class="brain-bar">
          <div class="brain-bar-fill" style="background:${r.color};width:50%"></div>
        </div>
      </div>
    `;
  });
}

// ============================================================================
// PHYSIOLOGICAL MODELS
// ============================================================================

// Respiratory Sinus Arrhythmia - heart rate varies with breathing
function computeRSA(respPhase) {
  // HR increases during inspiration, decreases during expiration
  return Math.sin(respPhase) * PHYSIO.RSA_AMPLITUDE;
}

// Baroreceptor reflex - blood pressure affects heart rate
function baroReflexModulation(systolicBP) {
  // Higher BP -> lower HR (negative feedback)
  const deviation = systolicBP - PHYSIO.BP_SYSTOLIC;
  return -deviation * 0.1; // BPM adjustment
}

// Generate realistic ECG waveform
function generateECG(cardiacPhase, isSystole) {
  const p = cardiacPhase;
  
  // P wave (atrial depolarization) - 0 to 0.1
  if (p < 0.1) {
    return 0.15 * Math.sin(p / 0.1 * Math.PI);
  }
  // PR segment - 0.1 to 0.15
  else if (p < 0.15) {
    return 0;
  }
  // QRS complex - 0.15 to 0.25
  else if (p < 0.17) {
    return -0.1; // Q
  }
  else if (p < 0.2) {
    return 0.9 * ((p - 0.17) / 0.03); // R upstroke
  }
  else if (p < 0.23) {
    return 0.9 - 1.1 * ((p - 0.2) / 0.03); // R down to S
  }
  else if (p < 0.25) {
    return -0.2 + 0.2 * ((p - 0.23) / 0.02); // S recovery
  }
  // ST segment - 0.25 to 0.35
  else if (p < 0.35) {
    return 0.02;
  }
  // T wave - 0.35 to 0.55
  else if (p < 0.55) {
    return 0.25 * Math.sin((p - 0.35) / 0.2 * Math.PI);
  }
  // Diastole
  else {
    return 0;
  }
}

// ============================================================================
// ANIMATION LOOP
// ============================================================================
let lastTime = performance.now();

function animate(now) {
  if (!running) {
    requestAnimationFrame(animate);
    return;
  }
  
  const dt = Math.min((now - lastTime) / 1000, 0.1);
  lastTime = now;
  simTime += dt;
  
  // Update respiration
  respCycle.phase = (simTime / PHYSIO.RESP_PERIOD) * 2 * Math.PI;
  respCycle.amplitude = Math.sin(respCycle.phase);
  
  // Compute RSA modulation
  const rsaMod = computeRSA(respCycle.phase);
  
  // Update heart with RSA coupling
  systems.heart.update(dt, simTime, rsaMod * 0.05);
  
  // Cardiac cycle timing
  const instantHR = PHYSIO.HR_BASE + rsaMod + baroReflexModulation(PHYSIO.BP_SYSTOLIC);
  const rrInterval = 60 / instantHR;
  const timeSinceLastBeat = simTime - cardiacCycle.lastBeatTime;
  
  cardiacCycle.phase = timeSinceLastBeat / rrInterval;
  cardiacCycle.isSystole = cardiacCycle.phase < PHYSIO.SYSTOLE_FRAC;
  
  // Detect heartbeat (rupture in cardiac CRR)
  const heartBeat = systems.heart.state === 'rupture';
  if (heartBeat) {
    cardiacCycle.lastBeatTime = simTime;
    cardiacCycle.rr_intervals.push(rrInterval * 1000);
    if (cardiacCycle.rr_intervals.length > 10) cardiacCycle.rr_intervals.shift();
  }
  
  // Update brain regions
  Object.entries(systems.brain).forEach(([k, sys]) => {
    // Cross-frequency coupling: prefrontal theta modulates gamma
    let coupling = 0;
    if (k === 'visual' || k === 'cerebellum') {
      coupling = (brainStates.prefrontal?.activity || 0) * 0.3;
    }
    sys.update(dt, simTime, coupling);
    brainStates[k] = {
      activity: Math.abs(sys.amplitude),
      state: sys.state,
      coherence: sys.coherence
    };
  });
  
  // Update visuals
  updateHeart(heartBeat);
  updateBrainVisuals();
  updateBloodParts(dt, heartBeat);
  updateNeuroParts(dt);
  updateWaveforms();
  updateMetrics();
  
  document.getElementById('timeVal').textContent = `t = ${simTime.toFixed(2)}s`;
  document.getElementById('hdrRuptures').textContent = totalRuptures;
  
  requestAnimationFrame(animate);
}

function updateHeart(beating) {
  const dot = document.getElementById('heartDot');
  const glow = document.getElementById('heartGlowC');
  const core = document.getElementById('heartCore');
  
  if (beating) {
    dot.classList.add('beat');
    glow.setAttribute('r', '6.5');
    glow.setAttribute('opacity', '0.65');
    core.setAttribute('r', '4.2');
  } else {
    dot.classList.remove('beat');
    glow.setAttribute('r', '5');
    glow.setAttribute('opacity', '0.3');
    core.setAttribute('r', '3.5');
  }
  
  // Compute instantaneous HR from RR intervals
  const avgRR = cardiacCycle.rr_intervals.length > 0 
    ? cardiacCycle.rr_intervals.reduce((a, b) => a + b, 0) / cardiacCycle.rr_intervals.length
    : 833;
  const hr = 60000 / avgRR;
  
  // HRV (RMSSD approximation)
  let hrv = 50;
  if (cardiacCycle.rr_intervals.length > 1) {
    const diffs = [];
    for (let i = 1; i < cardiacCycle.rr_intervals.length; i++) {
      diffs.push(Math.pow(cardiacCycle.rr_intervals[i] - cardiacCycle.rr_intervals[i-1], 2));
    }
    hrv = Math.sqrt(diffs.reduce((a, b) => a + b, 0) / diffs.length);
  }
  
  document.getElementById('bpmVal').textContent = hr.toFixed(0);
  document.getElementById('cardCoh').textContent = systems.heart.coherence.toFixed(3);
  document.getElementById('cardState').textContent = cardiacCycle.isSystole ? 'SYSTOLE' : 'DIASTOLE';
  document.getElementById('hdrHRV').textContent = hrv.toFixed(0);
  document.getElementById('hdrResp').textContent = (60 / PHYSIO.RESP_PERIOD).toFixed(0);
  
  // ECG waveform
  const ecgVal = generateECG(cardiacCycle.phase % 1, cardiacCycle.isSystole);
  waves.ecg.push(ecgVal * 0.5 + 0.5);
  if (waves.ecg.length > 120) waves.ecg.shift();
}

function updateBrainVisuals() {
  Object.entries(brainStates).forEach(([k, s]) => {
    const g = document.getElementById(`brain-${k}`);
    if (!g) return;
    
    const outer = g.querySelector('.br-outer');
    const inner = g.querySelector('.br-inner');
    
    outer.setAttribute('r', 1.5 + s.activity * 1.3);
    outer.setAttribute('opacity', 0.12 + s.activity * 0.2);
    inner.setAttribute('opacity', 0.4 + s.activity * 0.5);
    
    const li = document.getElementById(`bl-${k}`);
    if (li) {
      li.querySelector('.brain-bar-fill').style.width = `${s.activity * 100}%`;
    }
  });
}

function updateBloodParts(dt, beating) {
  const g = document.getElementById('bloodParts');
  g.innerHTML = '';
  
  if (viewMode === 'neuro') return;
  
  const flowMult = beating ? 1.6 : (cardiacCycle.isSystole ? 1.2 : 0.9);
  
  bloodParts.forEach(p => {
    p.progress += p.speed * flowMult;
    if (p.progress >= 1) p.progress = 0;
    
    const v = VESSELS[p.vessel];
    if (!v) return;
    
    const path = v.path;
    const seg = p.progress * (path.length - 1);
    const i = Math.min(Math.floor(seg), path.length - 2);
    const t = seg - i;
    
    const x = path[i][0] + (path[i+1][0] - path[i][0]) * t;
    const y = path[i][1] + (path[i+1][1] - path[i][1]) * t;
    
    g.innerHTML += `<circle cx="${x}" cy="${y}" r="0.45" fill="${p.isArtery ? '#fecaca' : '#bfdbfe'}" opacity="0.8"/>`;
  });
}

function updateNeuroParts(dt) {
  const g = document.getElementById('neuroParts');
  g.innerHTML = '';
  
  if (viewMode === 'circ') return;
  
  neuroParts.forEach(n => {
    const path = NEURAL_PATHS[n.pathway];
    if (!path) return;
    
    // Modulate speed by brain activity
    const originKey = path.type === 'motor' ? 'motor_l' : 
                      path.type === 'sensory' ? 'sensory_l' : 'brainstem';
    const activity = brainStates[originKey]?.activity || 0.5;
    
    n.progress += n.speed * (0.6 + activity * 0.8);
    n.active = activity > 0.2;
    if (n.progress >= 1) n.progress = 0;
    
    if (!n.active) return;
    
    const pts = path.path;
    const seg = n.progress * (pts.length - 1);
    const i = Math.min(Math.floor(seg), pts.length - 2);
    const t = seg - i;
    
    const x = pts[i][0] + (pts[i+1][0] - pts[i][0]) * t;
    const y = pts[i][1] + (pts[i+1][1] - pts[i][1]) * t;
    
    g.innerHTML += `
      <circle cx="${x}" cy="${y}" r="1.3" fill="${path.color}" opacity="0.2"/>
      <circle cx="${x}" cy="${y}" r="0.7" fill="${path.color}" opacity="0.85"/>
    `;
  });
}

function updateWaveforms() {
  // Brain bands
  const theta = brainStates.prefrontal?.activity || 0;
  const alpha = ((brainStates.sensory_l?.activity || 0) + (brainStates.sensory_r?.activity || 0)) / 2;
  const gamma = brainStates.visual?.activity || 0;
  
  waves.theta.push(theta);
  waves.alpha.push(alpha);
  waves.gamma.push(gamma);
  waves.resp.push((respCycle.amplitude + 1) / 2);
  
  [waves.theta, waves.alpha, waves.gamma, waves.resp].forEach(w => {
    if (w.length > 100) w.shift();
  });
  
  // Coherence
  waves.coherence.push(systems.heart.coherence);
  if (waves.coherence.length > 100) waves.coherence.shift();
  
  // Phase space
  waves.phase.push({ c: systems.heart.coherence, dc: systems.heart.dCdt });
  if (waves.phase.length > 200) waves.phase.shift();
  
  // Draw
  drawWave('ecgCanvas', waves.ecg, '#ef4444');
  drawWave('thetaCanvas', waves.theta, '#a855f7');
  drawWave('alphaCanvas', waves.alpha, '#22c55e');
  drawWave('gammaCanvas', waves.gamma, '#06b6d4');
  drawWave('respCanvas', waves.resp, '#06b6d4');
  drawCoherence();
  drawPhase();
  
  document.getElementById('thetaVal').textContent = theta.toFixed(2);
  document.getElementById('alphaVal').textContent = alpha.toFixed(2);
  document.getElementById('gammaVal').textContent = gamma.toFixed(2);
  document.getElementById('respRateVal').textContent = (60 / PHYSIO.RESP_PERIOD).toFixed(0);
}

function drawWave(id, data, color) {
  const c = document.getElementById(id);
  if (!c || data.length < 2) return;
  
  const ctx = c.getContext('2d');
  const w = c.width, h = c.height;
  ctx.clearRect(0, 0, w, h);
  
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  
  data.forEach((v, i) => {
    const x = (i / (data.length - 1)) * w;
    const y = h - v * h * 0.85 - h * 0.075;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  
  ctx.stroke();
}

function drawCoherence() {
  const c = document.getElementById('cohCanvas');
  if (!c) return;
  
  const ctx = c.getContext('2d');
  const w = c.width, h = c.height;
  ctx.clearRect(0, 0, w, h);
  
  // Threshold
  const maxC = omega * 1.5;
  const threshY = h * (1 - omega / maxC);
  
  ctx.strokeStyle = '#f59e0b';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 3]);
  ctx.beginPath();
  ctx.moveTo(0, threshY);
  ctx.lineTo(w, threshY);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Coherence
  if (waves.coherence.length < 2) return;
  
  ctx.strokeStyle = '#06b6d4';
  ctx.lineWidth = 2;
  ctx.beginPath();
  
  waves.coherence.forEach((v, i) => {
    const x = (i / (waves.coherence.length - 1)) * w;
    const y = h * (1 - v / maxC);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  
  ctx.stroke();
  
  // Fill
  ctx.lineTo(w, h);
  ctx.lineTo(0, h);
  ctx.closePath();
  ctx.fillStyle = 'rgba(6, 182, 212, 0.08)';
  ctx.fill();
}

function drawPhase() {
  const c = document.getElementById('phaseCanvas');
  if (!c || waves.phase.length < 2) return;
  
  const ctx = c.getContext('2d');
  const w = c.width, h = c.height;
  ctx.clearRect(0, 0, w, h);
  
  // Axes
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(0, h/2);
  ctx.lineTo(w, h/2);
  ctx.moveTo(w/2, 0);
  ctx.lineTo(w/2, h);
  ctx.stroke();
  
  // Trajectory
  const maxC = omega * 1.5;
  const maxDC = 3;
  
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  
  waves.phase.forEach((p, i) => {
    const x = (p.c / maxC) * w;
    const y = h/2 - (p.dc / maxDC) * h/2;
    
    const a = i / waves.phase.length;
    ctx.strokeStyle = `rgba(168, 85, 247, ${a})`;
    
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  
  ctx.stroke();
  
  // Current point
  const last = waves.phase[waves.phase.length - 1];
  if (last) {
    const x = (last.c / maxC) * w;
    const y = h/2 - (last.dc / maxDC) * h/2;
    
    ctx.beginPath();
    ctx.arc(x, y, 3.5, 0, Math.PI * 2);
    ctx.fillStyle = '#a855f7';
    ctx.fill();
  }
}

function updateMetrics() {
  const avgC = waves.coherence.length > 0 
    ? waves.coherence.reduce((a, b) => a + b, 0) / waves.coherence.length 
    : 0;
  
  const rupRate = simTime > 0 ? (totalRuptures / simTime) * 60 : 0;
  const expWt = Math.min(systems.heart.getExpWeight(), 99.99);
  
  document.getElementById('avgCoh').textContent = avgC.toFixed(3);
  document.getElementById('rupRate').textContent = rupRate.toFixed(1);
  document.getElementById('regenIdx').textContent = (1 + avgC / omega * 0.2).toFixed(2);
  document.getElementById('expWt').textContent = expWt.toFixed(2);
  
  // Coupling percentages
  const vagal = 75 + Math.sin(simTime * 0.3) * 12;
  const rsa = 65 + respCycle.amplitude * 15;
  const baro = 85 + Math.sin(simTime * 0.2) * 8;
  const cortAuto = 60 + (brainStates.prefrontal?.activity || 0) * 25;
  
  document.getElementById('vagalPct').textContent = `${vagal.toFixed(0)}%`;
  document.getElementById('rsaPct').textContent = `${rsa.toFixed(0)}%`;
  document.getElementById('baroPct').textContent = `${baro.toFixed(0)}%`;
  document.getElementById('cortAutoPct').textContent = `${cortAuto.toFixed(0)}%`;
}

// ============================================================================
// CONTROLS
// ============================================================================
function toggleSim() {
  running = !running;
  const btn = document.getElementById('playBtn');
  const icon = document.getElementById('playIcon');
  const lbl = document.getElementById('playLbl');
  
  if (running) {
    btn.classList.add('active');
    icon.textContent = '‚ñ∂';
    lbl.textContent = 'Running';
    lastTime = performance.now();
  } else {
    btn.classList.remove('active');
    icon.textContent = '‚è∏';
    lbl.textContent = 'Paused';
  }
}

function resetSim() {
  simTime = 0;
  totalRuptures = 0;
  cardiacCycle = { phase: 0, isSystole: false, lastBeatTime: 0, rr_intervals: [] };
  
  Object.values(waves).forEach(w => w.length = 0);
  
  systems.heart = new CRRSystem(omega * 1.2, 1.2, 'cardiac');
  systems.respiration = new CRRSystem(omega * 0.8, 0.2, 'resp');
  
  Object.entries(BRAIN_REGIONS).forEach(([k, r]) => {
    systems.brain[k] = new CRRSystem(omega * 1.8, r.freq, k);
  });
  
  bloodParts.forEach(p => p.progress = Math.random());
  neuroParts.forEach(n => n.progress = Math.random());
}

function setView(mode) {
  viewMode = mode;
  
  document.querySelectorAll('.view-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });
  
  const circ = document.getElementById('circSystem');
  const neuro = document.getElementById('neuroSystem');
  const brain = document.getElementById('brainParts');
  const heart = document.getElementById('heartGroup');
  
  if (mode === 'circ') {
    circ.style.opacity = '1';
    neuro.style.opacity = '0.12';
    brain.style.opacity = '0.12';
    heart.style.opacity = '1';
  } else if (mode === 'neuro') {
    circ.style.opacity = '0.12';
    neuro.style.opacity = '1';
    brain.style.opacity = '1';
    heart.style.opacity = '0.25';
  } else {
    circ.style.opacity = '1';
    neuro.style.opacity = '1';
    brain.style.opacity = '1';
    heart.style.opacity = '1';
  }
}

function setOmega(val) {
  omega = parseFloat(val);
  
  document.getElementById('omegaVal').textContent = omega.toFixed(4);
  document.getElementById('hdrOmega').textContent = omega.toFixed(4);
  
  systems.heart.setOmega(omega * 1.2);
  systems.respiration.setOmega(omega * 0.8);
  systems.baroreceptor.setOmega(omega * 1.5);
  
  Object.values(systems.brain).forEach(s => s.setOmega(omega * 1.8));
  
  // Update threshold line
  const line = document.getElementById('cohLine');
  const pos = 100 - (omega / (OMEGA_BASE * 1.5)) * 100;
  line.style.top = `${Math.max(5, Math.min(90, pos))}%`;
}

window.addEventListener('load', init);
window.addEventListener('resize', setupCanvases);
</script>
</body>
</html>
