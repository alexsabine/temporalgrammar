<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Fidelity Moss Growth Microscopy</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: #0a0f0a;
            color: #fff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
        }
        
        .microscope-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: 
                radial-gradient(circle at 30% 25%, rgba(20,40,20,0.3) 0%, transparent 50%),
                radial-gradient(circle at 70% 75%, rgba(25,50,30,0.2) 0%, transparent 50%),
                linear-gradient(135deg, #0a0f0a 0%, #0f1a0a 100%);
        }
        
        .microscope-view {
            position: relative;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            background: 
                radial-gradient(circle at 35% 25%, rgba(255,255,255,0.1) 0%, transparent 40%),
                radial-gradient(circle at center, #2a2520 0%, #1a150f 80%, #0f0f0a 100%);
            border: 12px solid #333;
            box-shadow: 
                0 0 50px rgba(0,0,0,0.9),
                inset 0 0 100px rgba(255,255,255,0.05),
                inset 0 0 40px rgba(0,0,0,0.6);
            overflow: hidden;
        }
        
        .microscope-view::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: radial-gradient(circle at 25% 20%, rgba(255,255,255,0.2) 0%, transparent 60%);
            pointer-events: none;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: block;
            image-rendering: smooth;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.95);
            padding: 20px;
            border-radius: 12px;
            font-size: 11px;
            line-height: 1.6;
            border: 1px solid #444;
            box-shadow: 0 5px 25px rgba(0,0,0,0.7);
        }
        
        .microscope-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 12px;
            font-size: 10px;
            border: 1px solid #444;
            min-width: 200px;
        }
        
        .growth-metrics {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 12px;
            font-size: 10px;
            border: 1px solid #444;
            min-width: 220px;
        }
        
        .environmental-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 12px;
            font-size: 10px;
            border: 1px solid #444;
            min-width: 180px;
        }
        
        .time-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.95);
            padding: 15px 25px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #555;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }
        
        .param-row {
            display: flex;
            align-items: center;
            margin: 6px 0;
            gap: 8px;
            justify-content: space-between;
        }
        
        .param-slider {
            width: 70px;
            height: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            border-radius: 2px;
        }
        
        .param-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #4a7c59;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4a7c59;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .play-btn:hover {
            background: #3a6b49;
            box-shadow: 0 0 15px rgba(74, 124, 89, 0.4);
        }
        
        .highlight { color: #4a7c59; }
        .time-display { 
            font-family: 'Courier New', monospace; 
            color: #4a7c59;
            font-weight: bold;
        }
        
        .magnification {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            color: #4a7c59;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div class="microscope-container">
        <div class="microscope-view">
            <canvas id="canvas"></canvas>
            <div class="magnification">üî¨ 400x Magnification - Real-time Growth</div>
        </div>
        
        <div class="controls">
            <div class="highlight">Microscope Controls</div>
            <div>Click: Add spore cluster</div>
            <div>Right-click: Add water droplet</div>
            <div>Shift+click: Add nutrients</div>
            <div>R: Reset specimen</div>
            <div>Space: Pause observation</div>
            <div style="margin-top: 10px; font-size: 9px; color: #888;">
                Observing moss gametophyte development in real-time
            </div>
        </div>
        
        <div class="microscope-info">
            <div class="highlight">Specimen Analysis</div>
            <div style="font-size: 9px; line-height: 1.4;">
                <div>Species: <em>Bryum capillare</em></div>
                <div>Stage: Gametophyte</div>
                <div>Magnification: 400x</div>
                <div>Field of view: 2mm¬≤</div>
                <div>Observation time: <span id="obsTime">0</span>min</div>
            </div>
            
            <div style="margin-top: 10px;">
                <div class="highlight">Cellular Activity</div>
                <div style="font-size: 9px;">
                    <div>Cell division rate: <span id="cellDivision">0</span>/min</div>
                    <div>Chlorophyll density: <span id="chlorophyll">Low</span></div>
                    <div>Water uptake: <span id="waterUptake">0</span>ŒºL/min</div>
                    <div>Photosynthesis: <span id="photosynthesis">Minimal</span></div>
                </div>
            </div>
        </div>
        
        <div class="growth-metrics">
            <div class="highlight">Growth Dynamics</div>
            <div style="font-size: 9px; line-height: 1.4;">
                <div>Protonema length: <span id="protonema">0</span>Œºm</div>
                <div>Bud formation: <span id="budCount">0</span></div>
                <div>Leaf primordia: <span id="leafPrimordia">0</span></div>
                <div>Rhizoid density: <span id="rhizoids">0</span>/mm¬≤</div>
                <div>Branch points: <span id="branches">0</span></div>
                <div>Apical growth: <span id="apicalGrowth">0</span>Œºm/h</div>
            </div>
            
            <div style="margin-top: 8px;">
                <div class="highlight">Morphology</div>
                <div style="font-size: 9px;">
                    <div>Stem diameter: <span id="stemDiam">0</span>Œºm</div>
                    <div>Leaf length: <span id="leafLen">0</span>Œºm</div>
                    <div>Cell wall thickness: <span id="cellWall">2.5</span>Œºm</div>
                </div>
            </div>
        </div>
        
        <div class="environmental-controls">
            <div class="highlight">Environment</div>
            <div class="param-row">
                <span>Humidity:</span>
                <input type="range" class="param-slider" id="humidity" min="40" max="95" value="80">
                <span id="humidityVal">80%</span>
            </div>
            <div class="param-row">
                <span>Light:</span>
                <input type="range" class="param-slider" id="light" min="10" max="60" value="35">
                <span id="lightVal">35%</span>
            </div>
            <div class="param-row">
                <span>CO‚ÇÇ:</span>
                <input type="range" class="param-slider" id="co2" min="300" max="1200" value="400">
                <span id="co2Val">400ppm</span>
            </div>
            <div class="param-row">
                <span>Growth rate:</span>
                <input type="range" class="param-slider" id="growthSpeed" min="1" max="10" value="5">
                <span id="speedVal">5x</span>
            </div>
        </div>
        
        <div class="time-controls">
            <button class="play-btn" id="playBtn">‚è∏</button>
            <div class="time-display">
                Time: <span id="timeDisplay">00:00</span>
            </div>
        </div>
    </div>

    <script>
        (() => {
            // High-fidelity microscopic view parameters
            const GRID_SIZE = 800;
            const TOTAL_CELLS = GRID_SIZE * GRID_SIZE;
            const CENTER_X = GRID_SIZE / 2;
            const CENTER_Y = GRID_SIZE / 2;
            const VIEW_RADIUS = GRID_SIZE * 0.48;
            
            // Accelerated time parameters
            let simulationTime = 0;
            let isPlaying = true;
            let growthSpeedMultiplier = 5;
            
            // Environmental parameters
            let humidity = 80;
            let lightLevel = 35;
            let co2Level = 400;
            
            // Canvas setup
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            canvas.width = canvas.height = GRID_SIZE;
            
            // High-resolution cellular fields
            let protonemal = new Float32Array(TOTAL_CELLS);      // Thread-like protonema
            let gametophore = new Float32Array(TOTAL_CELLS);     // Leafy shoots
            let rhizoids = new Float32Array(TOTAL_CELLS);        // Root-like structures
            let buds = new Float32Array(TOTAL_CELLS);            // Development buds
            let chloroplasts = new Float32Array(TOTAL_CELLS);    // Chlorophyll concentration
            let cellWalls = new Float32Array(TOTAL_CELLS);       // Cell structure
            let moisture = new Float32Array(TOTAL_CELLS);
            let nutrients = new Float32Array(TOTAL_CELLS);
            let memory = new Float32Array(TOTAL_CELLS);
            let cellAge = new Float32Array(TOTAL_CELLS);
            let temp = new Float32Array(TOTAL_CELLS);
            
            // Microscopic moss development agents
            class MossCell {
                constructor(x, y, type = 'protonema') {
                    this.x = x;
                    this.y = y;
                    this.vx = (Math.random() - 0.5) * 0.1;
                    this.vy = (Math.random() - 0.5) * 0.1;
                    this.type = type; // 'protonema', 'bud', 'gametophore', 'rhizoid'
                    this.age = 0;
                    this.energy = 0.9 + Math.random() * 0.2;
                    this.divisionCooldown = 0;
                    this.size = this.getTypeSize();
                    this.phase = Math.random() * Math.PI * 2;
                    this.branchAngle = Math.atan2(this.vy, this.vx);
                    this.generation = 0;
                    this.chlorophyllLevel = 0.1;
                }
                
                getTypeSize() {
                    switch(this.type) {
                        case 'protonema': return 0.3 + Math.random() * 0.2;
                        case 'bud': return 0.8 + Math.random() * 0.4;
                        case 'gametophore': return 1.2 + Math.random() * 0.6;
                        case 'rhizoid': return 0.2 + Math.random() * 0.1;
                        default: return 0.5;
                    }
                }
                
                update(cells) {
                    this.age += growthSpeedMultiplier;
                    this.phase += 0.03;
                    
                    // Environmental conditions affect growth
                    const stress = this.calculateStress();
                    const growthRate = (1 - stress) * growthSpeedMultiplier;
                    
                    if (stress > 0.9) {
                        this.energy *= 0.95;
                        return [];
                    }
                    
                    // Chlorophyll development
                    if (this.type !== 'rhizoid') {
                        this.chlorophyllLevel = Math.min(1, this.chlorophyllLevel + 0.001 * growthRate);
                    }
                    
                    const newCells = [];
                    
                    switch(this.type) {
                        case 'protonema':
                            newCells.push(...this.updateProtonema(stress, growthRate));
                            break;
                        case 'bud':
                            newCells.push(...this.updateBud(stress, growthRate));
                            break;
                        case 'gametophore':
                            newCells.push(...this.updateGametophore(stress, growthRate));
                            break;
                        case 'rhizoid':
                            this.updateRhizoid(stress, growthRate);
                            break;
                    }
                    
                    this.energy *= 0.9995;
                    return newCells;
                }
                
                updateProtonema(stress, growthRate) {
                    // Protonema grows as branching filaments
                    const sensor = this.senseEnvironment(4);
                    this.adjustDirection(sensor, 0.2);
                    this.move(0.15 * growthRate);
                    
                    this.depositMaterial('protonema', 0.02 * growthRate);
                    
                    const newCells = [];
                    this.divisionCooldown = Math.max(0, this.divisionCooldown - growthSpeedMultiplier);
                    
                    // Branch frequently
                    if (this.energy > 0.7 && this.divisionCooldown <= 0 && Math.random() < 0.008) {
                        const branchAngle = this.branchAngle + (Math.random() - 0.5) * Math.PI * 0.4;
                        const branch = new MossCell(this.x, this.y, 'protonema');
                        branch.vx = Math.cos(branchAngle) * 0.1;
                        branch.vy = Math.sin(branchAngle) * 0.1;
                        branch.branchAngle = branchAngle;
                        branch.generation = this.generation + 1;
                        newCells.push(branch);
                        
                        this.divisionCooldown = 20;
                        this.energy *= 0.8;
                    }
                    
                    // Form buds when conditions are right
                    if (this.age > 200 && this.energy > 0.8 && Math.random() < 0.003) {
                        const bud = new MossCell(this.x, this.y, 'bud');
                        newCells.push(bud);
                        this.energy *= 0.7;
                    }
                    
                    return newCells;
                }
                
                updateBud(stress, growthRate) {
                    // Buds develop into gametophores
                    this.depositMaterial('bud', 0.025 * growthRate);
                    
                    const newCells = [];
                    
                    // Mature into gametophore
                    if (this.age > 100 && this.energy > 0.6) {
                        const gametophore = new MossCell(this.x, this.y, 'gametophore');
                        gametophore.energy = this.energy * 0.9;
                        newCells.push(gametophore);
                        
                        // Create rhizoids for anchoring
                        for (let i = 0; i < 3; i++) {
                            const rhizoid = new MossCell(this.x, this.y, 'rhizoid');
                            const angle = Math.random() * Math.PI * 2;
                            rhizoid.vx = Math.cos(angle) * 0.05;
                            rhizoid.vy = Math.sin(angle) * 0.05;
                            newCells.push(rhizoid);
                        }
                        
                        this.energy = 0; // Bud consumed
                    }
                    
                    return newCells;
                }
                
                updateGametophore(stress, growthRate) {
                    // Gametophores are the leafy moss shoots
                    const sensor = this.senseEnvironment(3);
                    this.move(0.05 * growthRate); // Slow vertical growth
                    
                    this.depositMaterial('gametophore', 0.03 * growthRate);
                    
                    const newCells = [];
                    
                    // Create leaf-like structures
                    if (this.age > 50 && Math.random() < 0.005) {
                        for (let i = 0; i < 2; i++) {
                            const leaf = new MossCell(
                                this.x + (Math.random() - 0.5) * 4,
                                this.y + (Math.random() - 0.5) * 4,
                                'gametophore'
                            );
                            leaf.size = 0.6;
                            leaf.generation = this.generation + 1;
                            newCells.push(leaf);
                        }
                        this.energy *= 0.9;
                    }
                    
                    return newCells;
                }
                
                updateRhizoid(stress, growthRate) {
                    // Rhizoids grow downward and absorb nutrients
                    this.vy = Math.abs(this.vy) + 0.02; // Tend downward
                    this.move(0.08 * growthRate);
                    this.depositMaterial('rhizoid', 0.015 * growthRate);
                    
                    // Absorb nutrients
                    const idx = Math.floor(this.x) + Math.floor(this.y) * GRID_SIZE;
                    if (idx >= 0 && idx < TOTAL_CELLS) {
                        this.energy = Math.min(1.2, this.energy + nutrients[idx] * 0.02);
                    }
                }
                
                senseEnvironment(radius) {
                    let bestSignal = -1;
                    let bestAngle = this.branchAngle;
                    
                    const numSensors = 6;
                    for (let i = 0; i < numSensors; i++) {
                        const angle = (i * Math.PI * 2) / numSensors;
                        const sx = this.x + Math.cos(angle) * radius;
                        const sy = this.y + Math.sin(angle) * radius;
                        
                        if (this.inView(sx, sy)) {
                            const idx = Math.floor(sx) + Math.floor(sy) * GRID_SIZE;
                            let signal = moisture[idx] * 2 + nutrients[idx] * 1.5;
                            
                            // Avoid overcrowding
                            const density = protonemal[idx] + gametophore[idx] + buds[idx];
                            signal -= density * 1.8;
                            
                            // Light seeking for photosynthesis
                            if (this.type !== 'rhizoid') {
                                signal += lightLevel / 100;
                            }
                            
                            if (signal > bestSignal) {
                                bestSignal = signal;
                                bestAngle = angle;
                            }
                        }
                    }
                    
                    return { signal: bestSignal, angle: bestAngle };
                }
                
                adjustDirection(sensor, turnRate) {
                    const angleDiff = this.normalizeAngle(sensor.angle - this.branchAngle);
                    this.branchAngle += angleDiff * turnRate;
                    
                    const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                    this.vx = Math.cos(this.branchAngle) * speed;
                    this.vy = Math.sin(this.branchAngle) * speed;
                }
                
                move(speed) {
                    this.x += this.vx * speed;
                    this.y += this.vy * speed;
                    this.x = Math.max(5, Math.min(GRID_SIZE - 5, this.x));
                    this.y = Math.max(5, Math.min(GRID_SIZE - 5, this.y));
                }
                
                depositMaterial(type, amount) {
                    const radius = this.size + 0.5;
                    for (let dy = -radius; dy <= radius; dy++) {
                        for (let dx = -radius; dx <= radius; dx++) {
                            const px = Math.floor(this.x + dx);
                            const py = Math.floor(this.y + dy);
                            
                            if (this.inView(px, py)) {
                                const dist = Math.sqrt(dx * dx + dy * dy);
                                if (dist <= radius) {
                                    const idx = px + py * GRID_SIZE;
                                    const strength = Math.exp(-dist * dist / (radius * radius));
                                    
                                    switch(type) {
                                        case 'protonema':
                                            protonemal[idx] = Math.min(1, protonemal[idx] + amount * strength);
                                            chloroplasts[idx] = Math.min(1, chloroplasts[idx] + amount * 0.5 * strength);
                                            break;
                                        case 'bud':
                                            buds[idx] = Math.min(1, buds[idx] + amount * strength);
                                            break;
                                        case 'gametophore':
                                            gametophore[idx] = Math.min(1, gametophore[idx] + amount * strength);
                                            chloroplasts[idx] = Math.min(1, chloroplasts[idx] + amount * 0.8 * strength);
                                            break;
                                        case 'rhizoid':
                                            rhizoids[idx] = Math.min(1, rhizoids[idx] + amount * strength);
                                            break;
                                    }
                                    
                                    cellWalls[idx] = Math.min(1, cellWalls[idx] + amount * 0.3 * strength);
                                    cellAge[idx] = Math.min(1000, cellAge[idx] + 0.5 * strength);
                                    memory[idx] = Math.min(1, memory[idx] + 0.003 * strength);
                                    
                                    // Consume resources
                                    nutrients[idx] = Math.max(0, nutrients[idx] - 0.0005 * strength);
                                }
                            }
                        }
                    }
                }
                
                inView(x, y) {
                    if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) return false;
                    const dx = x - CENTER_X;
                    const dy = y - CENTER_Y;
                    return (dx * dx + dy * dy) <= VIEW_RADIUS * VIEW_RADIUS;
                }
                
                calculateStress() {
                    const humidityStress = Math.abs(humidity - 80) / 40;
                    const lightStress = Math.abs(lightLevel - 35) / 35;
                    const co2Stress = Math.abs(co2Level - 400) / 400;
                    return (humidityStress + lightStress + co2Stress) / 3;
                }
                
                normalizeAngle(angle) {
                    while (angle > Math.PI) angle -= 2 * Math.PI;
                    while (angle < -Math.PI) angle += 2 * Math.PI;
                    return angle;
                }
            }
            
            let mossCells = [];
            
            function initializeSimulation() {
                mossCells = [];
                simulationTime = 0;
                
                // Clear all fields
                protonemal.fill(0);
                gametophore.fill(0);
                rhizoids.fill(0);
                buds.fill(0);
                chloroplasts.fill(0);
                cellWalls.fill(0);
                cellAge.fill(0);
                memory.fill(0);
                
                // Initialize substrate
                for (let i = 0; i < TOTAL_CELLS; i++) {
                    nutrients[i] = 0.3 + Math.random() * 0.4;
                    moisture[i] = (humidity / 100) * (0.5 + Math.random() * 0.5);
                }
                
                // Add initial spore germination points
                addSporeGermination(CENTER_X - 80, CENTER_Y - 60);
                addSporeGermination(CENTER_X + 100, CENTER_Y + 40);
                addSporeGermination(CENTER_X - 40, CENTER_Y + 120);
            }
            
            function addSporeGermination(x, y) {
                // Simulate spore germination into protonema
                for (let i = 0; i < 12; i++) {
                    const cell = new MossCell(
                        x + (Math.random() - 0.5) * 20,
                        y + (Math.random() - 0.5) * 20,
                        'protonema'
                    );
                    cell.energy = 1.0;
                    mossCells.push(cell);
                }
            }
            
            function addWaterDroplet(x, y) {
                const radius = 30;
                for (let dy = -radius; dy <= radius; dy++) {
                    for (let dx = -radius; dx <= radius; dx++) {
                        const px = Math.floor(x + dx);
                        const py = Math.floor(y + dy);
                        
                        if (px >= 0 && px < GRID_SIZE && py >= 0 && py < GRID_SIZE) {
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist <= radius) {
                                const idx = px + py * GRID_SIZE;
                                const strength = Math.exp(-dist * dist / (radius * radius * 0.4));
                                moisture[idx] = Math.min(1, moisture[idx] + 0.6 * strength);
                            }
                        }
                    }
                }
            }
            
            function addNutrients(x, y) {
                const radius = 25;
                for (let dy = -radius; dy <= radius; dy++) {
                    for (let dx = -radius; dx <= radius; dx++) {
                        const px = Math.floor(x + dx);
                        const py = Math.floor(y + dy);
                        
                        if (px >= 0 && px < GRID_SIZE && py >= 0 && py < GRID_SIZE) {
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist <= radius) {
                                const idx = px + py * GRID_SIZE;
                                const strength = Math.exp(-dist * dist / (radius * radius * 0.3));
                                nutrients[idx] = Math.min(1, nutrients[idx] + 0.4 * strength);
                            }
                        }
                    }
                }
            }
            
            function simulationStep() {
                if (!isPlaying) return;
                
                // Update moss cells
                const newCells = [];
                for (let cell of mossCells) {
                    const offspring = cell.update(mossCells);
                    newCells.push(...offspring);
                }
                mossCells.push(...newCells);
                
                // Remove dead cells
                mossCells = mossCells.filter(c => c.energy > 0.05);
                
                // Environmental processes
                diffuse(moisture, 0.008);
                diffuse(nutrients, 0.005);
                diffuse(chloroplasts, 0.002);
                
                if (memory) {
                    for (let i = 0; i < TOTAL_CELLS; i++) {
                        memory[i] *= 0.999;
                    }
                    diffuse(memory, 0.003);
                }
                
                // Natural processes
                const evapRate = 1 - 0.001;
                for (let i = 0; i < TOTAL_CELLS; i++) {
                    moisture[i] *= evapRate;
                    
                    // Moss retains moisture
                    const mossPresence = protonemal[i] + gametophore[i] + rhizoids[i];
                    if (mossPresence > 0.1) {
                        moisture[i] = Math.min(1, moisture[i] + mossPresence * 0.003);
                    }
                }
                
                simulationTime += growthSpeedMultiplier;
                updateUI();
            }
            
            function diffuse(field, rate) {
                temp.fill(0);
                
                for (let y = 1; y < GRID_SIZE - 1; y++) {
                    for (let x = 1; x < GRID_SIZE - 1; x++) {
                        const idx = x + y * GRID_SIZE;
                        const neighbors = field[idx - 1] + field[idx + 1] + 
                                        field[idx - GRID_SIZE] + field[idx + GRID_SIZE];
                        temp[idx] = field[idx] + rate * (neighbors - 4 * field[idx]);
                    }
                }
                
                for (let i = 0; i < TOTAL_CELLS; i++) {
                    field[i] = Math.max(0, temp[i]);
                }
            }
            
            function updateUI() {
                // Calculate detailed microscopic metrics
                let totalProtonema = 0, totalGametophores = 0, totalBuds = 0;
                let totalRhizoids = 0, totalChlorophyll = 0;
                
                for (let i = 0; i < TOTAL_CELLS; i++) {
                    totalProtonema += protonemal[i];
                    totalGametophores += gametophore[i];
                    totalBuds += buds[i];
                    totalRhizoids += rhizoids[i];
                    totalChlorophyll += chloroplasts[i];
                }
                
                const minutes = Math.floor(simulationTime / 60);
                const seconds = Math.floor(simulationTime % 60);
                
                // Update microscopic measurements
                document.getElementById('obsTime').textContent = (simulationTime / 60).toFixed(1);
                document.getElementById('protonema').textContent = Math.floor(totalProtonema * 1000);
                document.getElementById('budCount').textContent = Math.floor(totalBuds * 100);
                document.getElementById('leafPrimordia').textContent = Math.floor(totalGametophores * 50);
                document.getElementById('rhizoids').textContent = Math.floor(totalRhizoids * 200);
                document.getElementById('branches').textContent = mossCells.length;
                document.getElementById('apicalGrowth').textContent = (mossCells.length * growthSpeedMultiplier * 2).toFixed(1);
                
                document.getElementById('stemDiam').textContent = (8 + Math.random() * 4).toFixed(1);
                document.getElementById('leafLen').textContent = (120 + Math.random() * 80).toFixed(0);
                
                document.getElementById('cellDivision').textContent = Math.floor(mossCells.length * 0.1);
                document.getElementById('chlorophyll').textContent = totalChlorophyll > 50 ? 'High' : totalChlorophyll > 20 ? 'Medium' : 'Low';
                document.getElementById('waterUptake').textContent = (totalRhizoids * 0.5).toFixed(2);
                document.getElementById('photosynthesis').textContent = totalChlorophyll > 30 ? 'Active' : 'Minimal';
                
                document.getElementById('timeDisplay').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            function render() {
                const imageData = context.createImageData(GRID_SIZE, GRID_SIZE);
                const pixels = imageData.data;
                
                for (let y = 0; y < GRID_SIZE; y++) {
                    for (let x = 0; x < GRID_SIZE; x++) {
                        const dx = x - CENTER_X;
                        const dy = y - CENTER_Y;
                        
                        if (dx * dx + dy * dy > VIEW_RADIUS * VIEW_RADIUS) {
                            continue; // Outside circular view
                        }
                        
                        const idx = x + y * GRID_SIZE;
                        const pixelIdx = idx * 4;
                        
                        const proto = protonemal[idx];
                        const gameto = gametophore[idx];
                        const bud = buds[idx];
                        const rhiz = rhizoids[idx];
                        const chloro = chloroplasts[idx];
                        const wall = cellWalls[idx];
                        const age = cellAge[idx];
                        const moist = moisture[idx];
                        
                        const totalMoss = proto + gameto + bud + rhiz;
                        
                        if (totalMoss > 0.01) {
                            // Ultra-high-fidelity moss rendering with natural muted colors
                            
                            // Base moss colors - dark, muted forest greens
                            let r = 8 + chloro * 12 + age * 0.04;
                            let g = 25 + chloro * 45 + gameto * 18 + proto * 10;
                            let b = 12 + chloro * 8 - age * 0.02;
                            
                            // Cell wall visibility - subtle brown tints
                            if (wall > 0.3) {
                                const wallEffect = wall * 0.3;
                                r += wallEffect * 15;
                                g += wallEffect * 10;
                                b += wallEffect * 5;
                            }
                            
                            // Protonema - young moss with muted olive-green
                            if (proto > 0.2) {
                                const protoIntensity = Math.min(1, proto * 2);
                                g += protoIntensity * 28;
                                r += protoIntensity * 8;
                                b += protoIntensity * 6;
                                
                                // Thread-like pattern - very subtle
                                const threadPattern = Math.sin(x * 0.8) * Math.cos(y * 0.3) * protoIntensity;
                                g += threadPattern * 12;
                                r += threadPattern * 4;
                            }
                            
                            // Gametophores - mature moss dark emerald
                            if (gameto > 0.3) {
                                const gametoIntensity = Math.min(1, gameto * 1.5);
                                g += gametoIntensity * 35;
                                r += gametoIntensity * 6;
                                b += gametoIntensity * 8;
                                
                                // Leaf-like cellular pattern - muted greens
                                const leafPattern = Math.sin(x * 0.4 + y * 0.6) * gametoIntensity;
                                g += leafPattern * 15;
                                r += leafPattern * 3;
                            }
                            
                            // Buds - fresh growth with subtle yellow-green
                            if (bud > 0.4) {
                                const budIntensity = Math.min(1, bud * 1.8);
                                r += budIntensity * 18;
                                g += budIntensity * 32;
                                b += budIntensity * 6;
                            }
                            
                            // Rhizoids - natural muted brown-red root colors
                            if (rhiz > 0.2) {
                                const rhizIntensity = Math.min(1, rhiz * 2);
                                r += rhizIntensity * 25;
                                g -= rhizIntensity * 8;
                                b += rhizIntensity * 15;
                            }
                            
                            // Microscopic detail texture
                            const microX = Math.sin(x * 1.2 + y * 0.8) * 0.2;
                            const microY = Math.cos(x * 0.9 + y * 1.1) * 0.15;
                            const cellularDetail = (microX + microY) * totalMoss * 20;
                            
                            r += cellularDetail;
                            g += cellularDetail;
                            b += cellularDetail * 0.5;
                            
                            // Individual cell boundaries (very fine detail)
                            const cellBoundary = Math.sin(x * 2.5) * Math.cos(y * 2.3) * wall * 15;
                            r += cellBoundary;
                            g += cellBoundary * 0.8;
                            b += cellBoundary * 0.6;
                            
                            // Moisture effect on appearance
                            if (moist > 0.6) {
                                r *= 0.85;
                                g *= 0.9;
                                b *= 0.85;
                            }
                            
                            // Age-based color variation
                            const ageEffect = Math.min(1, age / 500);
                            g += ageEffect * 20;
                            r += ageEffect * 10;
                            
                            pixels[pixelIdx] = Math.max(0, Math.min(255, r));
                            pixels[pixelIdx + 1] = Math.max(0, Math.min(255, g));
                            pixels[pixelIdx + 2] = Math.max(0, Math.min(255, b));
                            pixels[pixelIdx + 3] = 255;
                        } else {
                            // Substrate - microscopic organic matter
                            const substrateDetail = Math.sin(x * 0.3) * Math.cos(y * 0.4) * 10;
                            const moistEffect = 1 - moist * 0.5;
                            const nutrientGlow = nutrients[idx] * 20;
                            
                            const subR = (40 + substrateDetail + nutrientGlow) * moistEffect;
                            const subG = (30 + substrateDetail * 0.8 + nutrientGlow * 0.8) * moistEffect;
                            const subB = (20 + substrateDetail * 0.6 + nutrientGlow * 0.4) * moistEffect;
                            
                            pixels[pixelIdx] = Math.max(0, Math.min(255, subR));
                            pixels[pixelIdx + 1] = Math.max(0, Math.min(255, subG));
                            pixels[pixelIdx + 2] = Math.max(0, Math.min(255, subB));
                            pixels[pixelIdx + 3] = 255;
                        }
                    }
                }
                
                context.putImageData(imageData, 0, 0);
            }
            
            // Event handlers with circular view bounds
            function getCanvasCoords(e) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * GRID_SIZE / rect.width;
                const y = (e.clientY - rect.top) * GRID_SIZE / rect.height;
                
                const dx = x - CENTER_X;
                const dy = y - CENTER_Y;
                if (dx * dx + dy * dy <= VIEW_RADIUS * VIEW_RADIUS) {
                    return { x, y };
                }
                return null;
            }
            
            canvas.addEventListener('click', (e) => {
                const coords = getCanvasCoords(e);
                if (!coords) return;
                
                if (e.shiftKey) {
                    addNutrients(coords.x, coords.y);
                } else {
                    addSporeGermination(coords.x, coords.y);
                }
            });
            
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const coords = getCanvasCoords(e);
                if (coords) {
                    addWaterDroplet(coords.x, coords.y);
                }
            });
            
            // Controls
            function setupControls() {
                const params = ['humidity', 'light', 'co2', 'growthSpeed'];
                params.forEach(param => {
                    const slider = document.getElementById(param);
                    const display = document.getElementById(param === 'growthSpeed' ? 'speedVal' : param + 'Val');
                    
                    slider.oninput = function() {
                        const value = parseFloat(this.value);
                        switch(param) {
                            case 'humidity':
                                humidity = value;
                                display.textContent = value + '%';
                                break;
                            case 'light':
                                lightLevel = value;
                                display.textContent = value + '%';
                                break;
                            case 'co2':
                                co2Level = value;
                                display.textContent = value + 'ppm';
                                break;
                            case 'growthSpeed':
                                growthSpeedMultiplier = value;
                                display.textContent = value + 'x';
                                break;
                        }
                    };
                });
            }
            
            window.addEventListener('keydown', (e) => {
                switch (e.key.toLowerCase()) {
                    case 'r':
                        initializeSimulation();
                        break;
                    case ' ':
                        e.preventDefault();
                        isPlaying = !isPlaying;
                        document.getElementById('playBtn').innerHTML = isPlaying ? '‚è∏' : '‚ñ∂';
                        break;
                }
            });
            
            document.getElementById('playBtn').onclick = function() {
                isPlaying = !isPlaying;
                this.innerHTML = isPlaying ? '‚è∏' : '‚ñ∂';
            };
            
            function animationLoop() {
                simulationStep();
                render();
                requestAnimationFrame(animationLoop);
            }
            
            // Initialize
            setupControls();
            initializeSimulation();
            animationLoop();
        })();
    </script>
</body>
</html>