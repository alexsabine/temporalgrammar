<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEP-CRR Dynamics: Real-Time Correspondence</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Computer Modern', 'Latin Modern', 'Times New Roman', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #4a9eff;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5em;
            color: #4a9eff;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .subtitle {
            font-size: 1.2em;
            color: #a0a0a0;
            font-style: italic;
        }
        
        .equation-block {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #4a9eff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 1.1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .chart-title {
            color: #4a9eff;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 300;
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
            padding-bottom: 10px;
        }
        
        canvas {
            max-height: 350px;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .control-group {
            margin: 20px 0;
        }
        
        label {
            display: block;
            color: #4a9eff;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(74, 158, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
        }
        
        .value-display {
            display: inline-block;
            background: rgba(74, 158, 255, 0.2);
            padding: 4px 12px;
            border-radius: 4px;
            float: right;
            font-family: 'Courier New', monospace;
            color: #4a9eff;
        }
        
        button {
            background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(74, 158, 255, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .regime-indicator {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .regime-rigid { border-left-color: #ff6b6b; }
        .regime-balanced { border-left-color: #4ecdc4; }
        .regime-fluid { border-left-color: #ffe66d; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: rgba(74, 158, 255, 0.1);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-label {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #4a9eff;
            font-size: 1.8em;
            font-weight: 300;
            font-family: 'Courier New', monospace;
        }
        
        .correspondence-box {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .correspondence-arrow {
            color: #4caf50;
            font-size: 1.5em;
            text-align: center;
            margin: 10px 0;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid rgba(74, 158, 255, 0.3);
            color: #a0a0a0;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FEP-CRR Dynamical Correspondence</h1>
            <div class="subtitle">Real-Time Visualization of Coupled Free Energy & Coherence Dynamics</div>
        </header>

        <div class="equation-block">
            <strong>Core Relationship:</strong><br>
            \[
            \frac{dC}{dt} = -\frac{dF}{dt} \implies C(t) = F_0 - F(t)
            \]
            <div style="margin-top: 10px; font-size: 0.95em; color: #a0a0a0;">
                Coherence accumulation rate equals free energy reduction rate. Success creates rigidity.
            </div>
        </div>

        <div class="controls">
            <h2 style="color: #4a9eff; margin-bottom: 20px;">System Parameters</h2>
            
            <div class="control-group">
                <label>
                    Temperature Ω (Flexibility)
                    <span class="value-display" id="omega-val">1.5</span>
                </label>
                <input type="range" id="omega" min="0.3" max="4.0" step="0.1" value="1.5">
            </div>
            
            <div class="control-group">
                <label>
                    Environmental Volatility
                    <span class="value-display" id="volatility-val">0.5</span>
                </label>
                <input type="range" id="volatility" min="0.1" max="2.0" step="0.1" value="0.5">
            </div>
            
            <div class="control-group">
                <label>
                    Learning Rate η
                    <span class="value-display" id="learning-val">0.1</span>
                </label>
                <input type="range" id="learning" min="0.01" max="0.5" step="0.01" value="0.1">
            </div>
            
            <div style="margin-top: 25px;">
                <button onclick="resetSimulation()">Reset Simulation</button>
                <button onclick="togglePause()">Pause/Resume</button>
                <button onclick="triggerRupture()">Trigger Rupture</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Free Energy F(t)</div>
                <div class="stat-value" id="stat-F">0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Coherence C(t)</div>
                <div class="stat-value" id="stat-C">0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Precision Π(t)</div>
                <div class="stat-value" id="stat-Pi">0.00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Memory Depth τ<sub>eff</sub></div>
                <div class="stat-value" id="stat-tau">0.00</div>
            </div>
        </div>

        <div class="regime-indicator" id="regime-indicator">
            <strong>Current Regime:</strong> <span id="regime-text">Initializing...</span><br>
            <span id="regime-desc" style="font-size: 0.9em; color: #a0a0a0;"></span>
        </div>

        <div class="grid">
            <div class="chart-container">
                <div class="chart-title">Inverse Relationship: F(t) & C(t)</div>
                <canvas id="fc-chart"></canvas>
                <div style="margin-top: 10px; font-size: 0.85em; color: #a0a0a0;">
                    \(C(t) = F_0 - F(t)\): As free energy decreases, coherence accumulates
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Phase Portrait: (C, dC/dt)</div>
                <canvas id="phase-chart"></canvas>
                <div style="margin-top: 10px; font-size: 0.85em; color: #a0a0a0;">
                    Trajectory shows approach to rupture threshold
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Precision-Coherence: Π(t) ∝ e<sup>C/Ω</sup></div>
                <canvas id="precision-chart"></canvas>
                <div style="margin-top: 10px; font-size: 0.85em; color: #a0a0a0;">
                    Exponential memory amplification with learning
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Expected Free Energy: G(π)</div>
                <canvas id="efg-chart"></canvas>
                <div style="margin-top: 10px; font-size: 0.85em; color: #a0a0a0;">
                    Exploration vs Exploitation balance controlled by Ω
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Memory Depth Evolution</div>
                <canvas id="memory-chart"></canvas>
                <div style="margin-top: 10px; font-size: 0.85em; color: #a0a0a0;">
                    \(\tau_{eff} = \int_0^t e^{C(\tau)/\Omega} d\tau\): Non-Markovian transition
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Exploration-Exploitation Spectrum</div>
                <canvas id="spectrum-chart"></canvas>
                <div style="margin-top: 10px; font-size: 0.85em; color: #a0a0a0;">
                    Policy weighting: \(\text{Score}(\pi) = \Omega \cdot \text{Epistemic} + \frac{1}{\Omega} \cdot \text{Pragmatic}\)
                </div>
            </div>
        </div>

        <div class="correspondence-box">
            <h3 style="color: #4caf50; margin-bottom: 15px;">Key Correspondences</h3>
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
                <div style="text-align: right;">
                    <strong style="color: #4a9eff;">FEP</strong><br>
                    Variational Free Energy F<br>
                    Precision Π = 1/σ²<br>
                    Expected Free Energy G(π)<br>
                    Model Switching<br>
                    Markov Blanket
                </div>
                <div class="correspondence-arrow">⟷</div>
                <div style="text-align: left;">
                    <strong style="color: #4caf50;">CRR</strong><br>
                    Coherence C = F₀ - F<br>
                    Memory Weight e<sup>C/Ω</sup>/Ω<br>
                    Expected Coherence Gain<br>
                    Rupture δ(t-t₀)<br>
                    Coherence Gradient ∇C
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Interactive visualization of the Free Energy Principle ⟷ Coherence-Rupture-Regeneration correspondence</p>
            <p style="margin-top: 10px;">Based on Friston (2010), Ramstead et al. (2018), and CRR Framework (Sabine, 2025)</p>
        </div>
    </div>

    <script>
        // Global state
        let state = {
            F: 5.0,
            C: 0.0,
            dC: 0.0,
            Omega: 1.5,
            volatility: 0.5,
            learningRate: 0.1,
            time: 0,
            isPaused: false,
            history: {
                time: [],
                F: [],
                C: [],
                dC: [],
                Pi: [],
                memoryDepth: [],
                epistemic: [],
                pragmatic: []
            },
            maxHistory: 200
        };

        // Chart configurations
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: true,
            animation: false,
            plugins: {
                legend: {
                    labels: { color: '#e0e0e0' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#a0a0a0' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                },
                y: {
                    ticks: { color: '#a0a0a0' },
                    grid: { color: 'rgba(74, 158, 255, 0.1)' }
                }
            }
        };

        // Initialize charts
        const fcChart = new Chart(document.getElementById('fc-chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Free Energy F(t)',
                    data: [],
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }, {
                    label: 'Coherence C(t)',
                    data: [],
                    borderColor: '#4ecdc4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }]
            },
            options: chartConfig
        });

        const phaseChart = new Chart(document.getElementById('phase-chart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Trajectory',
                    data: [],
                    borderColor: '#ffe66d',
                    backgroundColor: 'rgba(255, 230, 109, 0.6)',
                    showLine: true,
                    tension: 0.4,
                    pointRadius: 3,
                    borderWidth: 2
                }, {
                    label: 'Rupture Threshold',
                    data: [],
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.3)',
                    showLine: true,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    borderWidth: 2
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    x: {
                        title: { display: true, text: 'Coherence C', color: '#a0a0a0' },
                        ticks: { color: '#a0a0a0' },
                        grid: { color: 'rgba(74, 158, 255, 0.1)' }
                    },
                    y: {
                        title: { display: true, text: 'dC/dt', color: '#a0a0a0' },
                        ticks: { color: '#a0a0a0' },
                        grid: { color: 'rgba(74, 158, 255, 0.1)' }
                    }
                }
            }
        });

        const precisionChart = new Chart(document.getElementById('precision-chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Precision Π(t)',
                    data: [],
                    borderColor: '#4a9eff',
                    backgroundColor: 'rgba(74, 158, 255, 0.1)',
                    tension: 0.4,
                    borderWidth: 2,
                    yAxisID: 'y'
                }, {
                    label: 'Coherence C(t)',
                    data: [],
                    borderColor: '#4ecdc4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    tension: 0.4,
                    borderWidth: 2,
                    yAxisID: 'y1'
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    x: {
                        ticks: { color: '#a0a0a0' },
                        grid: { color: 'rgba(74, 158, 255, 0.1)' }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Precision Π', color: '#a0a0a0' },
                        ticks: { color: '#a0a0a0' },
                        grid: { color: 'rgba(74, 158, 255, 0.1)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Coherence C', color: '#a0a0a0' },
                        ticks: { color: '#a0a0a0' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        const efgChart = new Chart(document.getElementById('efg-chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Epistemic Value',
                    data: [],
                    borderColor: '#ffe66d',
                    backgroundColor: 'rgba(255, 230, 109, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }, {
                    label: 'Pragmatic Value',
                    data: [],
                    borderColor: '#a29bfe',
                    backgroundColor: 'rgba(162, 155, 254, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }]
            },
            options: chartConfig
        });

        const memoryChart = new Chart(document.getElementById('memory-chart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Effective Memory Depth τ_eff',
                    data: [],
                    borderColor: '#fd79a8',
                    backgroundColor: 'rgba(253, 121, 168, 0.1)',
                    tension: 0.4,
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: chartConfig
        });

        const spectrumChart = new Chart(document.getElementById('spectrum-chart'), {
            type: 'bar',
            data: {
                labels: ['Exploration', 'Exploitation'],
                datasets: [{
                    label: 'Policy Weight',
                    data: [0.5, 0.5],
                    backgroundColor: ['rgba(255, 230, 109, 0.6)', 'rgba(162, 155, 254, 0.6)'],
                    borderColor: ['#ffe66d', '#a29bfe'],
                    borderWidth: 2
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        ticks: { color: '#a0a0a0' },
                        grid: { color: 'rgba(74, 158, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#a0a0a0' },
                        grid: { display: false }
                    }
                }
            }
        });

        // Physics and dynamics
        function computePrecision(C, Omega) {
            return Math.exp(C / Omega) / Omega;
        }

        function computeMemoryDepth(C, Omega, dt = 0.1) {
            // Approximate integral: τ_eff ≈ sum of e^(C/Ω) over history
            return Math.exp(C / Omega) * dt;
        }

        function computeExpectedFreeEnergy(C, Omega) {
            // Epistemic value (exploration) increases with Ω
            const epistemic = Omega * (1 - Math.exp(-C / 5));
            
            // Pragmatic value (exploitation) decreases with Ω
            const pragmatic = (1 / Omega) * Math.exp(-C / 3);
            
            return { epistemic, pragmatic };
        }

        function updateDynamics(dt) {
            // Environmental perturbation (noise)
            const noise = (Math.random() - 0.5) * state.volatility;
            
            // FEP: Free energy minimization with prediction error
            const predictionError = noise;
            const dF = -state.learningRate * (state.F - 1.0) + predictionError;
            
            // CRR: Coherence accumulation (inverse of F reduction)
            state.dC = -dF;
            
            // Update state
            state.F += dF * dt;
            state.C += state.dC * dt;
            
            // Ensure F stays positive and bounded
            state.F = Math.max(0.1, Math.min(10.0, state.F));
            state.C = Math.max(0, state.C);
            
            // Check rupture condition
            const Ccrit = state.Omega * Math.log(20); // C_crit = Ω * ln(phase space volume)
            if (state.C > Ccrit) {
                triggerRupture();
            }
            
            state.time += dt;
        }

        function triggerRupture() {
            // Rupture event: partial coherence reset and F spike
            const alpha = 0.3; // Reset factor
            state.C *= alpha;
            state.F += 2.0 * Math.random(); // Energy injection
            
            console.log(`Rupture at t=${state.time.toFixed(2)}: C reset from ${(state.C/alpha).toFixed(2)} to ${state.C.toFixed(2)}`);
        }

        function updateHistory() {
            const Pi = computePrecision(state.C, state.Omega);
            const memDepth = computeMemoryDepth(state.C, state.Omega);
            const { epistemic, pragmatic } = computeExpectedFreeEnergy(state.C, state.Omega);
            
            state.history.time.push(state.time);
            state.history.F.push(state.F);
            state.history.C.push(state.C);
            state.history.dC.push(state.dC);
            state.history.Pi.push(Pi);
            state.history.memoryDepth.push(memDepth);
            state.history.epistemic.push(epistemic);
            state.history.pragmatic.push(pragmatic);
            
            // Trim history
            Object.keys(state.history).forEach(key => {
                if (state.history[key].length > state.maxHistory) {
                    state.history[key].shift();
                }
            });
        }

        function updateCharts() {
            // F-C inverse relationship
            fcChart.data.labels = state.history.time.map(t => t.toFixed(1));
            fcChart.data.datasets[0].data = state.history.F;
            fcChart.data.datasets[1].data = state.history.C;
            fcChart.update('none');
            
            // Phase portrait
            const phaseData = state.history.C.map((c, i) => ({
                x: c,
                y: state.history.dC[i]
            }));
            phaseChart.data.datasets[0].data = phaseData;
            
            // Rupture threshold line
            const Ccrit = state.Omega * Math.log(20);
            phaseChart.data.datasets[1].data = [
                { x: Ccrit, y: -2 },
                { x: Ccrit, y: 2 }
            ];
            phaseChart.update('none');
            
            // Precision-Coherence
            precisionChart.data.labels = state.history.time.map(t => t.toFixed(1));
            precisionChart.data.datasets[0].data = state.history.Pi;
            precisionChart.data.datasets[1].data = state.history.C;
            precisionChart.update('none');
            
            // Expected Free Energy
            efgChart.data.labels = state.history.time.map(t => t.toFixed(1));
            efgChart.data.datasets[0].data = state.history.epistemic;
            efgChart.data.datasets[1].data = state.history.pragmatic;
            efgChart.update('none');
            
            // Memory depth
            memoryChart.data.labels = state.history.time.map(t => t.toFixed(1));
            memoryChart.data.datasets[0].data = state.history.memoryDepth;
            memoryChart.update('none');
            
            // Exploration-exploitation spectrum
            const { epistemic, pragmatic } = computeExpectedFreeEnergy(state.C, state.Omega);
            const total = epistemic + pragmatic;
            spectrumChart.data.datasets[0].data = [
                epistemic / total,
                pragmatic / total
            ];
            spectrumChart.update('none');
        }

        function updateStats() {
            document.getElementById('stat-F').textContent = state.F.toFixed(3);
            document.getElementById('stat-C').textContent = state.C.toFixed(3);
            
            const Pi = computePrecision(state.C, state.Omega);
            document.getElementById('stat-Pi').textContent = Pi.toFixed(3);
            
            const cumMemDepth = state.history.memoryDepth.reduce((a, b) => a + b, 0);
            document.getElementById('stat-tau').textContent = cumMemDepth.toFixed(2);
        }

        function updateRegime() {
            const indicator = document.getElementById('regime-indicator');
            const text = document.getElementById('regime-text');
            const desc = document.getElementById('regime-desc');
            
            indicator.className = 'regime-indicator';
            
            if (state.Omega < 0.8) {
                indicator.classList.add('regime-rigid');
                text.textContent = 'RIGID (Crystalline)';
                desc.textContent = 'High precision, low exploration. Past dominates present. Risk of catastrophic forgetting.';
            } else if (state.Omega < 2.0) {
                indicator.classList.add('regime-balanced');
                text.textContent = 'BALANCED (Liquid)';
                desc.textContent = 'Optimal exploration-exploitation tradeoff. Experience guides, curiosity propels.';
            } else {
                indicator.classList.add('regime-fluid');
                text.textContent = 'FLUID (Gaseous)';
                desc.textContent = 'High exploration, low precision. Structure dissolves, creativity maximal.';
            }
        }

        // Control handlers
        document.getElementById('omega').addEventListener('input', (e) => {
            state.Omega = parseFloat(e.target.value);
            document.getElementById('omega-val').textContent = state.Omega.toFixed(1);
            updateRegime();
        });

        document.getElementById('volatility').addEventListener('input', (e) => {
            state.volatility = parseFloat(e.target.value);
            document.getElementById('volatility-val').textContent = state.volatility.toFixed(1);
        });

        document.getElementById('learning').addEventListener('input', (e) => {
            state.learningRate = parseFloat(e.target.value);
            document.getElementById('learning-val').textContent = state.learningRate.toFixed(2);
        });

        function resetSimulation() {
            state.F = 5.0;
            state.C = 0.0;
            state.dC = 0.0;
            state.time = 0;
            
            Object.keys(state.history).forEach(key => {
                state.history[key] = [];
            });
            
            console.log('Simulation reset');
        }

        function togglePause() {
            state.isPaused = !state.isPaused;
            console.log(state.isPaused ? 'Paused' : 'Resumed');
        }

        // Main animation loop
        function animate() {
            if (!state.isPaused) {
                const dt = 0.1;
                updateDynamics(dt);
                updateHistory();
                updateCharts();
                updateStats();
            }
            
            requestAnimationFrame(animate);
        }

        // Initialize
        updateRegime();
        animate();
        
        // Render MathJax after load
        window.addEventListener('load', () => {
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        });
    </script>
</body>
</html>